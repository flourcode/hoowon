<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta property="og:image" content="images/hoowon.png">
  <title>Hoowon - Federal Contract Intelligence</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible+Next:ital,wght@0,200..800;1,200..800&display=swap" rel="stylesheet">
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/d3-sankey/0.12.3/d3-sankey.min.js"></script>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-BZM1YXC1RQ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-BZM1YXC1RQ');
</script>
<style>
:root {
  /* Structural Variables (Unchanged by themes) */
  --space-xs: 0.25rem;
  --space-sm: 0.5rem;
  --space: 1rem;
  --space-lg: 1.5rem;
  --space-xl: 2rem;
  --space-2xl: 3rem;
  --font-family: "Atkinson Hyperlegible Next", sans-serif;
  --radius: 4px;
  --transition: all 0.2s ease-in-out;
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
}

/* Dynamically set theme variables will be applied here */
body {
  font-family: var(--font-family);
  background: var(--bg-secondary);
  color: var(--text-primary);
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
  transition: background 0.3s, color 0.3s;
}

/* --- Theme Controls --- */
.theme-controls {
  display: flex;
  gap: var(--space-sm);
  background-color: var(--bg-secondary);
  padding: var(--space-xs);
  border-radius: var(--radius);
  border: 1px solid var(--border);
}

.theme-btn {
  padding: var(--space-sm) var(--space);
  font-size: 0.75rem;
  font-weight: 600;
  border-radius: var(--radius);
  cursor: pointer;
  background: transparent;
  color: var(--text-secondary);
  border: none;
  transition: var(--transition);
}

.theme-btn.active {
  background: var(--bg-primary);
  color: var(--text-primary);
  box-shadow: var(--shadow);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

.app-container { min-height: 100vh; max-width: 1600px; margin: 0 auto; background: var(--bg-primary); }
.app-header { background: var(--bg-primary); border-bottom: 1px solid var(--border); padding: var(--space-lg) var(--space-xl); position: static; top: 0; z-index: 100; }
.header-content { display: flex; flex-direction: column; gap: var(--space-lg); }
.logo-main { display: flex; justify-content: space-between; align-items: flex-start; }
.logo-brand { display: flex; align-items: center; gap: var(--space); }
.logo-brand span { font-size: 2.8rem; font-weight: 800; color: var(--text-primary); }
.logo-subtitle { font-size: 0.875rem; color: var(--text-secondary); margin-top: var(--space-xs); }
.data-load-controls { display: flex; gap: var(--space); margin-bottom: var(--space); }
.controls-section { display: flex; flex-direction: column; gap: var(--space-lg); }
.main-filters { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: var(--space); align-items: end; }
.form-input, .form-select { padding: var(--space) var(--space-lg); border: 1px solid var(--border); border-radius: var(--radius); background: var(--bg-primary); color: var(--text-primary); font-size: 0.875rem; transition: var(--transition); }
.form-input:focus, .form-select:focus { outline: none; border-color: var(--text-primary); box-shadow: 0 0 0 3px rgba(33, 37, 41, 0.1); }
.search-wrapper { position: relative; }
.search-input { padding-left: var(--space); }
.btn { display: inline-flex; align-items: center; gap: var(--space-sm); padding: var(--space) var(--space-lg); font-size: 0.875rem; font-weight: 500; border: 1px solid transparent; border-radius: var(--radius); cursor: pointer; transition: all 0.2s ease-in-out; text-decoration: none; background: transparent; }
.btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
.btn:active { transform: translateY(0); }
.btn-primary { background: var(--primary); color: var(--bg-primary); font-weight: 600; }
.btn-primary:hover { background: var(--primary-dark); }
.btn-secondary { background: var(--bg-tertiary); color: var(--text-secondary); border-color: var(--border); font-weight: 500; }
.btn-secondary:hover { background: var(--bg-tertiary); color: var(--text-primary); }
.btn-sm { padding: var(--space-sm) var(--space); font-size: 0.75rem; }
.file-input { display: none; }
.advanced-filters { background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: var(--radius); padding: var(--space-lg); margin-top: var(--space-lg); display: none; }
.advanced-filters.active { display: block; }
.filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-lg); }
.form-group { display: flex; flex-direction: column; gap: var(--space-xs); }
.form-label { font-size: 0.75rem; font-weight: 600; color: var(--text-primary); text-transform: uppercase; letter-spacing: 0.05em; }
.dashboard { padding: var(--space-xl); display: flex; flex-direction: column; gap: var(--space); }
.section-title { font-size: 2.25rem; color: var(--text-primary); margin-bottom: var(--space-lg); border-bottom: none; padding-bottom: var(--space-sm); font-weight: 600; line-height: 1.2; letter-spacing: -1.5px; }
.section-title strong { font-weight: 700; color: var(--text-primary); }
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space); margin-bottom: var(--space-sm); }
.stat-card { background: var(--bg-primary); border: 1px solid var(--border); border-radius: var(--radius); padding: var(--space); }
.stat-label { font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: var(--space-sm); }
.stat-value { font-family: var(--font-family); font-size: 2.5rem; font-weight: 600; color: var(--text-primary); letter-spacing: -1px; }
.stat-company { font-size: 1.8rem; font-weight: 600; color: var(--text-primary); }
.chart-section { background: var(--bg-primary); border: 1px solid var(--border); border-radius: var(--radius); padding: var(--space-xl); margin-bottom: var(--space-sm); color: var(--text-primary); }
.chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg); }
.chart-controls { display: flex; gap: var(--space-sm); }
.primary-charts { display: grid; grid-template-columns: 3fr 2fr; gap: var(--space-xl); height: 450px; }
.chart-container { position: relative; height: 100%; max-height: 450px; overflow: visible; padding-bottom: 40px; display: flex; flex-direction: column; justify-content: center; }
.sankey-container { width: 100%; height: 100%; overflow: hidden; }
.industry-chart-container { display: flex; flex-direction: column; justify-content: center; align-items: center; padding-top: var(--space-lg); }
.table-section { background: var(--bg-primary); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
.tabs { display: flex; background: var(--bg-tertiary); border-bottom: 1px solid var(--border); }
.tab-btn { padding: var(--space) var(--space-lg); background: none; border: none; color: var(--text-secondary); font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: var(--transition); }
.tab-btn.active, .tab-btn:hover { color: var(--text-primary); background: var(--bg-primary); }
.tab-content { display: none; padding: var(--space-xl); }
.tab-content.active { display: block; }
.data-table { width: 100%; border-collapse: collapse; }
.data-table th { background: var(--bg-secondary); padding: var(--space); text-align: left; font-weight: 600; color: var(--text-primary); border-bottom: 2px solid var(--border); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; }
.data-table td { padding: var(--space); border-bottom: 1px solid var(--border); color: var(--text-primary); font-size: 0.875rem; }
.data-table tr:hover { background: var(--bg-tertiary); }
.entity-badge { display: inline-flex; align-items: center; gap: var(--space-sm); }
.entity-icon { width: 1.5rem; height: 1.5rem; border-radius: 2px; display: flex; align-items: center; justify-content: center; font-size: 0.625rem; font-weight: 700; flex-shrink: 0; }
.modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: var(--transition); }
.modal-backdrop.active { opacity: 1; visibility: visible; }
.modal { background: var(--bg-primary); border: 1px solid var(--border); border-radius: var(--radius); width: 90%; max-width: 600px; max-height: 80vh; overflow: auto; }
.modal-header { padding: var(--space-lg); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.modal-body { padding: var(--space-lg); }
.modal-footer { padding: var(--space-lg); border-top: 1px solid var(--border); display: flex; justify-content: flex-end; }
.loading-state, .empty-state, .error-state { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: var(--space-2xl); text-align: center; }
.loading-spinner { width: 2rem; height: 2rem; border: 2px solid var(--border); border-top: 2px solid var(--text-primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: var(--space); }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.error-state { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; border-radius: var(--radius); }
.hidden { display: none !important; }
.truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.active-filters-display { font-size: 1rem; color: var(--text-secondary); margin-top: var(--space-xs); font-weight: 500; height: 1.5em; }
.active-filters-display strong { color: var(--text-primary); font-weight: 600; }
.logo-mark { display: inline-flex; align-items: center; background: var(--primary); color: var(--primary-text); padding: var(--space) var(--space-lg); border-radius: 6px; font-size: 2rem; font-weight: 700; line-height: 1; }
.data-load-controls { display: flex; flex-direction: column; gap: var(--space); }
.example-datasets { display: flex; flex-direction: column; gap: var(--space-sm); }
.dataset-label { font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; }
.dataset-buttons { display: flex; gap: var(--space-sm); flex-wrap: wrap; }
.upload-section { padding-top: var(--space); border-top: 1px solid var(--border); }

/* Empty State Styles */
.empty-state-content { max-width: 800px; }
.empty-state-title { font-size: 2.5rem; font-weight: 700; color: var(--text-primary); margin-bottom: var(--space-lg); }
.empty-state-intro { font-size: 1.125rem; color: var(--text-secondary); margin-bottom: var(--space-2xl); line-height: 1.6; }
.how-to-guide { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius); padding: var(--space-2xl); margin-bottom: var(--space-2xl); text-align: left; }
.how-to-guide h3 { font-size: 1.5rem; font-weight: 600; color: var(--text-primary); margin-bottom: var(--space-lg); text-align: center; }
.how-to-guide ol { list-style: none; counter-reset: step-counter; }
.how-to-guide li { counter-increment: step-counter; margin-bottom: var(--space-lg); padding-left: var(--space-2xl); position: relative; }
.how-to-guide li:before { content: counter(step-counter); position: absolute; left: 0; top: 0; background: var(--primary); color: var(--primary-text); width: 1.5rem; height: 1.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.875rem; }
.how-to-guide li strong { color: var(--text-primary); font-weight: 600; }
.how-to-guide li p { margin-top: var(--space-xs); color: var(--text-secondary); }
.empty-state-prompt { font-size: 1rem; color: var(--text-secondary); }

.app-footer-enhanced { background: var(--bg-primary); border-top: 1px solid var(--border); padding: var(--space-2xl) var(--space-xl); margin-top: 0; }
.footer-content { max-width: 1200px; margin: 0 auto; }
.explainer-section { text-align: center; margin-bottom: var(--space-2xl); padding-bottom: var(--space-xl); border-bottom: 1px solid var(--border); }
.explainer-section h3 { font-size: 1.5rem; font-weight: 600; color: var(--text-primary); margin-bottom: var(--space); }
.explainer-section p { font-size: 1rem; color: var(--text-secondary); margin-bottom: var(--space-xl); max-width: 800px; margin-left: auto; margin-right: auto; }
.explainer-section a, .step-text a, .footer-links a { color: var(--primary); text-decoration: none; font-weight: 500; transition: var(--transition); }
.explainer-section a:hover, .step-text a:hover, .footer-links a:hover { color: var(--primary-dark); text-decoration: underline; }
.quick-steps { display: flex; justify-content: center; gap: var(--space-xl); max-width: 900px; margin: 0 auto; }
.step-row { display: flex; align-items: flex-start; gap: var(--space); flex: 1; text-align: left; }
.step-number { display: flex; align-items: center; justify-content: center; width: 1.75rem; height: 1.75rem; background: var(--primary); color: var(--primary-text); border-radius: 50%; font-weight: 600; font-size: 0.875rem; flex-shrink: 0; }
.step-text strong { color: var(--text-primary); font-weight: 600; }
.step-text { font-size: 0.875rem; color: var(--text-secondary); line-height: 1.5; }
.footer-grid-expanded { display: grid; grid-template-columns: 1.2fr 1fr 1fr; gap: var(--space-xl); }
.footer-section h3 { font-size: 1.25rem; font-weight: 600; color: var(--text-primary); margin-bottom: var(--space-lg); }
.connect-card-compact { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius); padding: var(--space-lg); display: flex; gap: var(--space); align-items: flex-start; }
.connect-avatar {
  flex-shrink: 0;
}

.connect-avatar img { 
  width: 50px; 
  height: 50px; 
  border-radius: 50%; 
  object-fit: cover; 
  border: 2px solid var(--border); 
  display: block;
}
.connect-info h4 { font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-bottom: var(--space-xs); }
.connect-info p { font-size: 0.875rem; color: var(--text-secondary); margin-bottom: var(--space); line-height: 1.5; }
.connect-buttons { display: flex; gap: var(--space-sm); }
.user-types { display: flex; flex-direction: column; gap: var(--space); margin-bottom: var(--space); }
.user-type { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius); padding: var(--space-sm); font-size: 0.875rem; line-height: 1.4; }
.user-type strong { color: var(--text-primary); font-weight: 600; display: block; margin-bottom: var(--space-xs); }
.search-examples-compact { display: flex; flex-direction: column; gap: var(--space); margin-bottom: var(--space-lg); }
.search-example-compact { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius); padding: var(--space-sm); }
.search-example-compact strong { display: block; color: var(--text-primary); font-size: 0.8rem; margin-bottom: var(--space-xs); font-weight: 600; }
.search-example-compact code { background: var(--bg-tertiary); padding: var(--space-xs) var(--space-sm); border-radius: var(--radius); font-size: 0.7rem; font-family: 'Courier New', monospace; color: var(--text-primary); display: block; word-break: break-all; border: 1px solid var(--border); }
.footer-links { display: flex; flex-direction: column; gap: var(--space-sm); }
.footer-links a { color: var(--primary); text-decoration: none; font-weight: 500; font-size: 0.875rem; display: inline-flex; align-items: center; gap: var(--space-sm); transition: var(--transition); }
.footer-links a:hover { color: var(--primary-dark); text-decoration: underline; }
.footer-links a i { color: var(--primary); width: 1rem; }
.copyright { border-top: 1px solid var(--border); margin-top: var(--space-xl); padding-top: var(--space-xl); text-align: center; font-size: 0.875rem; color: var(--text-tertiary); }

/* --- NEW COMBO BOX & UPDATED COMPARISON STYLES --- */
.comparison-controls { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius); padding: var(--space); margin-top: var(--space); }
.comparison-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space); }
.vendor-selectors { display: grid; grid-template-columns: 1fr 1fr auto; gap: var(--space); align-items: end; padding: var(--space); background: var(--bg-secondary); border-radius: var(--radius); border: 1px solid var(--border); }
.comparison-stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-sm); text-align: center; }
.comparison-stat-grid .stat-label { font-size: 0.7rem; margin-bottom: var(--space-xs); }
.comparison-stat-grid .stat-value { font-size: 1.5rem; line-height: 1; }
.comparison-close { background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-secondary); }
.comparison-close:hover { background: var(--bg-secondary); color: var(--text-primary); }
.overlap-chart-container .axis .domain, .overlap-chart-container .axis .tick line { stroke: var(--text-secondary); }
.overlap-chart-container .axis .tick text { fill: var(--text-secondary); font-size: 10px; }
.overlap-chart-container .y-axis text { fill: var(--text-primary); font-size: 11px; }

/* Searchable Dropdown (Combo Box) */
.combo-box { position: relative; }
.combo-box-input { width: 100%; cursor: pointer; transition: border-color 0.2s; }
.combo-box-input::placeholder { color: var(--text-secondary); transition: color 0.2s; }
.combo-box-input.error { border-color: #dc3545; }
.combo-box-input.error::placeholder { color: #dc3545; }
.combo-box-arrow { position: absolute; right: var(--space); top: 50%; transform: translateY(-50%); pointer-events: none; color: var(--text-secondary); }
.combo-box-options { display: none; position: absolute; top: 100%; left: 0; right: 0; background: var(--bg-primary); border: 1px solid var(--border); border-radius: var(--radius); z-index: 100; max-height: 250px; overflow-y: auto; box-shadow: var(--shadow); }
.combo-box.open .combo-box-options { display: block; }
.combo-box-option { padding: var(--space-sm) var(--space); cursor: pointer; font-size: 0.875rem; }
.combo-box-option:hover, .combo-box-option.highlighted { background: var(--bg-tertiary); }
.combo-box-option.hidden { display: none; }

.text-right { text-align: right; }
.overlap-chart-container .y-axis text {
  font-size: 10px;
  max-width: 200px;
}

/* Loading States */
.comparison-loading {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 200px;
  color: var(--text-secondary);
  font-size: 0.875rem;
}

.comparison-loading .loading-spinner {
  width: 1.5rem;
  height: 1.5rem;
  margin-right: var(--space);
}

.chart-loading {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: var(--bg-primary);
  padding: var(--space);
  border-radius: var(--radius);
  z-index: 10;
}

.comparison-error {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 200px;
  color: var(--text-secondary);
  text-align: center;
  padding: var(--space);
}

.comparison-error h4 {
  color: var(--text-primary);
  margin-bottom: var(--space-sm);
}

/* Mobile fixes - comprehensive layout improvements */
@media (max-width: 768px) {
  /* Ensure main container doesn't overflow */
  body, html {
    overflow-x: hidden;
    max-width: 100vw;
  }

  .app-container {
    overflow-x: hidden;
    max-width: 100vw;
  }

  .app-header { 
    padding: var(--space) var(--space-lg); 
  }
  
  .dashboard { 
    padding: var(--space-lg); 
  }

  /* Fix chart section and header layout */
  .chart-section {
    padding: var(--space) var(--space-sm);
    overflow-x: hidden;
  }

  .chart-header {
    flex-direction: column;
    align-items: stretch;
    gap: var(--space);
  }

  /* Fix chart controls - make them wrap and fit container */
  .chart-controls {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-xs);
    justify-content: center;
    width: 100%;
    max-width: 100%;
  }

  .chart-controls .btn {
    flex: 1;
    min-width: 0;
    padding: var(--space-xs) var(--space-sm);
    font-size: 0.7rem;
    white-space: nowrap;
    max-width: calc(33.333% - var(--space-xs));
  }

  /* Fix sankeyControls container specifically */
  #sankeyControls {
    width: 100%;
    max-width: 100%;
    overflow: hidden;
  }

  #sankeyControls .btn {
    min-width: 0;
    flex: 1;
    max-width: calc(33.333% - var(--space-xs));
  }

  /* Fix section title to prevent overflow */
  .section-title {
    font-size: 1.5rem;
    line-height: 1.3;
    word-wrap: break-word;
    hyphens: auto;
  }

  /* Fix main filters layout */
  .main-filters { 
    grid-template-columns: 1fr; 
    gap: var(--space-sm);
  }

  /* Fix comparison controls layout */
  .vendor-selectors {
    grid-template-columns: 1fr;
    gap: var(--space-sm);
    padding: var(--space-sm);
  }

  .comparison-controls {
    margin-top: var(--space-sm);
    padding: var(--space-sm);
  }

  .comparison-header {
    flex-direction: column;
    gap: var(--space-sm);
    align-items: stretch;
  }

  .comparison-stat-grid .stat-value { 
    font-size: 1.2rem; 
  }

  /* Fix combo box dropdowns for mobile */
  .combo-box {
    width: 100%;
    max-width: 100%;
  }

  .combo-box-input {
    width: 100%;
    min-height: 44px;
    font-size: 16px; /* Prevents zoom on iOS */
    padding: var(--space) var(--space-sm);
  }

  .combo-box-options {
    max-height: 200px;
    left: 0;
    right: 0;
    width: 100%;
    box-sizing: border-box;
  }

  .combo-box-option {
    padding: var(--space) var(--space-lg);
    font-size: 0.9rem;
    min-height: 44px;
    display: flex;
    align-items: center;
    word-wrap: break-word;
    hyphens: auto;
  }

  /* Fix advanced filters */
  .filters-grid {
    grid-template-columns: 1fr;
    gap: var(--space);
  }

  /* Fix select elements */
  .form-select, .form-input {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    font-size: 16px; /* Prevents zoom on iOS */
  }

  /* Fix button groups */
  .dataset-buttons {
    flex-direction: column;
    gap: var(--space-xs);
  }

  .dataset-buttons .btn {
    width: 100%;
    justify-content: center;
  }

  /* Fix stats grid */
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-sm);
  }

  /* Fix primary charts container */
  .primary-charts { 
    grid-template-columns: 1fr; 
    height: auto; 
    gap: var(--space-lg); 
  }
  
  .chart-container { 
    height: 300px;
    max-height: 300px;
  }

  .sankey-container { 
    height: 300px; 
    overflow: hidden;
  }

  /* Fix table sections */
  .table-section { 
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  .data-table {
    min-width: 600px; /* Ensure table doesn't compress too much */
    font-size: 0.75rem;
  }
  
  .data-table th,
  .data-table td {
    padding: var(--space-xs) var(--space-sm);
    white-space: nowrap;
  }

  .data-table td:first-child {
    white-space: nowrap;
    min-width: 60px;
    font-size: 0.75rem;
    font-family: 'Courier New', monospace;
    letter-spacing: -0.5px;
  }

  /* Fix tabs */
  .tabs {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  .tab-btn {
    white-space: nowrap;
    flex-shrink: 0;
  }

  /* Fix modal for mobile */
  .modal {
    width: 95%;
    max-width: 95%;
    margin: var(--space);
    max-height: 90vh;
  }

  /* Fix footer layout */
  .footer-grid-expanded {
    grid-template-columns: 1fr;
    gap: var(--space);
  }

  .quick-steps {
    flex-direction: column;
    gap: var(--space);
  }

  /* Ensure no horizontal scrolling */
  * {
    max-width: 100%;
    box-sizing: border-box;
  }
}

/* Additional fixes for very small screens */
@media (max-width: 480px) {
  .chart-controls .btn {
    font-size: 0.65rem;
    padding: var(--space-xs);
  }

  .section-title {
    font-size: 1.25rem;
  }

  .stat-value {
    font-size: 1.8rem;
  }

  .combo-box-option {
    font-size: 0.8rem;
    padding: var(--space-sm);
  }
}

/* Landscape mobile fixes */
@media (max-width: 768px) and (orientation: landscape) {
  .chart-container {
    height: 250px;
  }
  
  .sankey-container {
    height: 250px;
  }
}
@media (max-width: 768px) {
  .data-table th,
  .data-table td {
    padding: var(--space-xs) var(--space-sm);
  }
  
  /* Make specific columns narrower */
  .data-table td:nth-child(1), /* Date */
  .data-table th:nth-child(1) {
    width: 70px;
    padding: var(--space-xs) var(--space-xs);
  }
  
  .data-table td:nth-child(2), /* Contract ID */
  .data-table th:nth-child(2) {
    width: 80px;
    padding: var(--space-xs) var(--space-xs);
  }
  
  .data-table td:nth-child(8), /* Actions */
  .data-table th:nth-child(8) {
    width: 60px;
    padding: var(--space-xs) var(--space-xs);
    position: sticky;
    right: 0;
    background: var(--bg-primary);
    border-left: 1px solid var(--border);
  }
}
@media (max-width: 768px) {
  .connect-card-compact {
    flex-direction: column;
    gap: var(--space);
    padding: var(--space);
    text-align: center;
  }
  
  .connect-avatar {
    align-self: center;
  }
  
  .connect-avatar img {
    width: 60px;
    height: 60px;
  }
  
  .connect-info {
    text-align: left;
  }
  
  .connect-info h4 {
    font-size: 1.125rem;
    margin-bottom: var(--space-sm);
  }
  
  .connect-info p {
    font-size: 0.8rem;
    line-height: 1.4;
    margin-bottom: var(--space-sm);
  }
  
  .connect-buttons {
    flex-wrap: wrap;
    gap: var(--space-xs);
    justify-content: center;
  }
  
  .connect-buttons .btn {
    flex: 1;
    min-width: 80px;
    font-size: 0.75rem;
    padding: var(--space-sm);
  }
  
  /* Ensure the entire footer section has proper mobile constraints */
  .footer-section {
    padding: 0 var(--space);
    overflow-wrap: break-word;
    word-wrap: break-word;
    hyphens: auto;
  }
  
  .footer-content {
    padding: 0 var(--space);
    max-width: 100%;
    overflow-x: hidden;
  }
}
/* FPDS Search Builder */
.fpds-search-builder {
  background: var(--bg-primary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: var(--space-xl);
  margin-bottom: var(--space-xl);
}

.search-builder-title {
  font-size: 2.25rem;
  color: var(--text-primary);
  margin-bottom: var(--space-lg);
  font-weight: 600;
  line-height: 1.2;
  letter-spacing: -1.5px;
}

.quick-templates {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: var(--space-sm);
  margin-bottom: var(--space-lg);
}

.template-card {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: var(--space);
  cursor: pointer;
  transition: var(--transition);
}

.template-card:hover {
  background: var(--bg-tertiary);
  transform: translateY(-1px);
}

.template-title {
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: var(--space-xs);
  font-size: 0.875rem;
}

.template-desc {
  font-size: 0.75rem;
  color: var(--text-secondary);
  line-height: 1.4;
}

.search-form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: var(--space);
  margin-bottom: var(--space-lg);
}

.search-output-section {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: var(--space);
  margin-top: var(--space);
  display: none;
}

.search-string-display {
  width: 100%;
  min-height: 80px;
  font-family: 'Courier New', monospace;
  font-size: 0.875rem;
  padding: var(--space);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--bg-primary);
  resize: vertical;
  color: var(--text-primary);
}

.search-actions {
  display: flex;
  gap: var(--space-sm);
  margin-top: var(--space);
  flex-wrap: wrap;
}

.search-preview {
  margin-top: var(--space);
  padding: var(--space);
  background: var(--bg-tertiary);
  border-radius: var(--radius);
  display: none;
  font-size: 0.875rem;
  color: var(--text-secondary);
}

.search-instructions-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
  display: none;
  align-items: center;
  justify-content: center;
}

.search-instructions-content {
  background: var(--bg-primary);
  padding: var(--space-xl);
  border-radius: var(--radius);
  max-width: 600px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
}

.search-instructions-content h3 {
  color: var(--text-primary);
  margin-bottom: var(--space);
}

.search-instructions-content ol {
  line-height: 1.6;
  margin: var(--space) 0;
  color: var(--text-primary);
}

.search-instructions-content li {
  margin-bottom: var(--space-sm);
}

/* Mobile responsiveness */
@media (max-width: 768px) {
  .search-form-grid {
    grid-template-columns: 1fr;
  }
  
  .quick-templates {
    grid-template-columns: 1fr;
  }
  
  .search-actions {
    flex-direction: column;
  }
  
  .search-actions .btn {
    width: 100%;
    justify-content: center;
  }
}
.data-source-banner {
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: var(--space-sm) var(--space);
  margin-bottom: var(--space);
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 0.875rem;
  color: var(--text-secondary);
}

.data-source-banner.hidden {
  display: none;
}

.data-source-text {
  display: flex;
  align-items: center;
  gap: var(--space-sm);
}

.data-source-icon {
  color: var(--primary);
}

.data-source-filename {
  font-weight: 600;
  color: var(--text-primary);
}
.search-form-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: var(--space);
  margin-bottom: var(--space-lg);
}

/* Mobile override */
@media (max-width: 768px) {
  .search-form-grid {
    grid-template-columns: 1fr;
  }
}
</style>
</head>
<body>
  <div class="app-container">
    <header class="app-header">
      <div class="header-content">
        <div class="logo-main">
          <div>
            <div class="logo-brand"><div class="logo-mark">Hoowon?</div></div>
            <div class="logo-subtitle">Look Back to See the Future.</div>
          </div>
          <div class="theme-controls" id="themeControls">
            <button class="theme-btn" data-theme="light">Light</button>
            <button class="theme-btn" data-theme="dark">Dark</button>
          </div>
        </div>
        <div class="data-load-controls">
          <div class="example-datasets">
            <div class="dataset-label">Load Example Data:</div>
            <div class="dataset-buttons">
              <button class="btn btn-primary btn-sm" data-dataset="dhs_CY24_25">DHS Awards CY24-25</button>
			  <button class="btn btn-primary btn-sm" data-dataset="DISA_CY24_25">DISA Awards CY24-25</button>
			  <button class="btn btn-primary btn-sm" data-dataset="USAF_SEP24">Air Force Sep 24</button>
			  <button class="btn btn-primary btn-sm" data-dataset="NAICS_611310_Colleges">Colleges and Uni</button>
			  <button class="btn btn-primary btn-sm" data-dataset="PSC_DA10_SaaS">PSC DA10 SaaS</button>
			<button class="btn btn-primary btn-sm" data-dataset="PSC_DA01_IT_Labor">PSC DA01 IT Labor</button>
              
            </div>
          </div>
          <div class="upload-section">
            <input type="file" id="csvFile" class="file-input" accept=".csv"><label for="csvFile" class="btn btn-secondary">Upload any fpds.gov CSV</label>
          </div>
        </div>
        <div class="controls-section" id="controlsSection" style="display: none;">
          <div class="main-filters">
            <div class="search-wrapper"><input type="text" id="searchInput" class="form-input search-input" placeholder="Search contracts, agencies, vendors..."></div>
            <select id="agencyFilter" class="form-select"><option value="">All Agencies</option></select>
            <select id="vendorFilter" class="form-select"><option value="">All Vendors</option></select>
            <select id="naicsFilter" class="form-select"><option value="">All NAICS</option></select>
            <div style="display: flex; gap: var(--space-sm);">
              <button id="resetBtn" class="btn btn-secondary btn-sm">Reset</button>
              <button id="moreFiltersBtn" class="btn btn-secondary btn-sm">More</button>
            </div>
          </div>
          <div class="comparison-controls" id="comparisonControls" style="display: none;">
            <div class="comparison-header">
              <button id="toggleComparison" class="btn btn-secondary comparison-toggle-btn"><i class="fas fa-balance-scale"></i> Compare Vendors</button>
              <button id="closeComparison" class="btn btn-secondary btn-sm comparison-close hidden"><i class="fas fa-times"></i> Exit Comparison</button>
            </div>
            <div class="vendor-selectors hidden" id="vendorSelectors">
              <div class="combo-box" id="vendorAComboBox">
                  <input type="text" id="vendorAInput" placeholder="Select Vendor A" class="form-input combo-box-input" autocomplete="off">
                  <i class="fas fa-chevron-down combo-box-arrow"></i>
                  <div class="combo-box-options" id="vendorAOptions"></div>
              </div>
              <div class="combo-box" id="vendorBComboBox">
                  <input type="text" id="vendorBInput" placeholder="Select Vendor B" class="form-input combo-box-input" autocomplete="off">
                  <i class="fas fa-chevron-down combo-box-arrow"></i>
                  <div class="combo-box-options" id="vendorBOptions"></div>
              </div>
              <button id="runComparison" class="btn btn-primary btn-sm">Compare</button>
            </div>
          </div>
          <div class="advanced-filters" id="advancedFilters">
            <div class="filters-grid">
              <div class="form-group"><label class="form-label">Start Date</label><input type="date" id="startDate" class="form-input"></div>
              <div class="form-group"><label class="form-label">End Date</label><input type="date" id="endDate" class="form-input"></div>
              <div class="form-group"><label class="form-label">Office</label><select id="officeFilter" class="form-select"><option value="">Any Office</option></select></div>
              <div class="form-group"><label class="form-label">Value Range</label><select id="valueFilter" class="form-select"><option value="">Any Value</option><option value="0-100000">Under $100K</option><option value="100000-500000">$100K - $500K</option><option value="500000-1000000">$500K - $1M</option><option value="1000000-5000000">$1M - $5M</option><option value="5000000-10000000">$5M - $10M</option><option value="10000000-999999999999">Over $10M</option></select></div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <div id="loadingState" class="loading-state hidden"><div class="loading-spinner"></div><p>Processing contract data...</p></div>
    <div id="errorState" class="error-state hidden"><h2>Error Loading Data</h2><p id="errorMessage"></p><div id="parseWarnings" class="hidden" style="margin-top: var(--space); padding: var(--space); background: #fff3cd; color: #856404; border-radius: var(--radius);"></div></div>
    
    <div id="emptyState" class="empty-state">
      <div class="empty-state-content">
        <h2 class="empty-state-title">Historical Data is Your Secret Sales Weapon</h2>
        <p class="empty-state-intro">Looking at old contract awards isn't just about what you missed—it's about seeing the future. By analyzing the government's past buying habits, you can stop guessing and start making strategic decisions. It's like having the competition's playbook before the game starts.</p>
        <div class="how-to-guide">
          <h3>How To Use This Tool</h3>
          <ol>
            <li><strong>Find Contract Data</strong><p>Go to FPDS.gov, perform a search, and export the results as a CSV file.</p></li>
            <li><strong>Upload & Analyze</strong><p>Upload the CSV to visualize spending, identify vendors, and find opportunities.</p></li>
            <li><strong>Filter & Explore</strong><p>Use the interactive filters and click on charts to narrow results and gain insights.</p></li>
          </ol>
        </div>
        <p class="empty-state-prompt">Use the buttons in the header to load example data or upload your own CSV to begin.</p>
      </div>
    </div>

    <main class="dashboard hidden" id="dashboard">
      <section>
<div class="data-source-banner hidden" id="dataSourceBanner">
  <div class="data-source-text">
    <i class="fas fa-file-csv data-source-icon"></i>
    <span>Currently viewing: <span class="data-source-filename" id="dataSourceFilename">example.csv</span></span>
  </div>
  <button class="btn btn-sm btn-secondary" onclick="hideDataSourceBanner()">
    <i class="fas fa-times"></i>
  </button>
</div>
        <div class="stats-grid">
          <div class="stat-card" id="statCard1"><div class="stat-label">Total Value</div><div class="stat-value" id="totalValue">$0</div></div>
          <div class="stat-card" id="statCard2"><div class="stat-label">Contracts</div><div class="stat-value" id="totalContracts">0</div></div>
          <div class="stat-card" id="statCard3"><div class="stat-label">Companies</div><div class="stat-value" id="totalCompanies">0</div></div>
          <div class="stat-card" id="statCard4"><div class="stat-label">Market Leader</div><div class="stat-company" id="topCompany">-</div></div>
        </div>
      </section>
      <section class="chart-section">
        <div class="chart-header">
         <div>
          <h2 class="section-title" id="primaryChartTitle">Award Flow & NAICS Distribution</h2>
          <div id="filterDisplay" class="active-filters-display"></div>
        </div>
          <div class="chart-controls" id="sankeyControls">
            <button id="sankeyLimit10" class="btn btn-sm btn-primary">Top 10</button>
            <button id="sankeyLimit25" class="btn btn-sm btn-secondary">Top 25</button>
            <button id="sankeyLimitAll" class="btn btn-sm btn-secondary">All</button>
          </div>
        </div>
        <div class="primary-charts">
          <div id="sankeyChart" class="sankey-container"></div>
          <div class="chart-container industry-chart-container"><canvas id="industryChart"></canvas></div>
        </div>
      </section>
	 
      <section class="chart-section">
        <h2 class="section-title" style="margin-bottom: var(--space);">Seasonal Buying Pattern</h2>
        <div class="chart-container" style="height: 200px; max-height: 200px; padding-bottom: 5px;"><canvas id="timelineChart"></canvas></div>
      </section>
	  <section class="chart-section fpds-search-builder">
  <h2 class="search-builder-title">FPDS Search Builder</h2>
  
  <!-- Quick Templates -->
  <div class="quick-templates">
    <div class="template-card" onclick="loadSearchTemplate('it-services')">
      <div class="template-title">IT Services & Software</div>
      <div class="template-desc">NAICS 541519, recent awards over $100K</div>
    </div>
    <div class="template-card" onclick="loadSearchTemplate('cloud-saas')">
      <div class="template-title">Cloud/SaaS Services</div>
      <div class="template-desc">NAICS 518210/511210, subscription services</div>
    </div>
    <div class="template-card" onclick="loadSearchTemplate('large-awards')">
      <div class="template-title">Large Recent Awards</div>
      <div class="template-desc">Awards over $5M in the last 12 months</div>
    </div>
    <div class="template-card" onclick="loadSearchTemplate('competitor-intel')">
      <div class="template-title">Competitor Intelligence</div>
      <div class="template-desc">Search by company name in descriptions</div>
    </div>
  </div>
  
  <div class="search-form-grid">
  <!-- First Row: Search Type and Code Selection -->
  <div class="form-group">
    <label class="form-label">Search Type</label>
    <select id="fpdsSearchType" class="form-select" onchange="toggleCodeOptions()">
      <option value="naics">NAICS Code (Industry)</option>
      <option value="psc">PSC Code (Procurement Intent)</option>
    </select>
  </div>
  
  <div class="form-group" id="naicsGroup">
    <label class="form-label">NAICS Code</label>
    <select id="fpdsNaicsCode" class="form-select">
      <option value="">Any Industry</option>
      <option value="541519">541519 - IT Services</option>
      <option value="511210">511210 - Software Publishers</option>
      <option value="518210">518210 - Data Processing/Cloud</option>
      <option value="541511">541511 - Custom Programming</option>
      <option value="541512">541512 - Systems Design</option>
      <option value="334111">334111 - Computer Manufacturing</option>
    </select>
  </div>
  
  <div class="form-group hidden" id="pscGroup">
    <label class="form-label">PSC Code</label>
    <select id="fpdsPscCode" class="form-select">
      <option value="">Any PSC</option>
      <option value="DA10">DA10 - IT & Telecom - SaaS/Cloud Services</option>
      <option value="DA01">DA01 - IT & Telecom - IT Labor Services</option>
      <option value="D302">D302 - IT Software</option>
      <option value="D307">D307 - IT Hardware</option>
      <option value="D316">D316 - IT Support Services</option>
      <option value="D399">D399 - Other IT Services</option>
    </select>
  </div>
  
  <!-- Second Row: Agency and Dates -->
  <div class="form-group">
    <label class="form-label">Agency</label>
    <select id="fpdsAgencyName" class="form-select">
      <option value="">Any Agency</option>
      <option value="DEPT OF THE NAVY">Navy</option>
      <option value="DEPT OF THE ARMY">Army</option>
      <option value="DEPT OF THE AIR FORCE">Air Force</option>
      <option value="DEFENSE LOGISTICS AGENCY">Defense Logistics Agency</option>
      <option value="VETERANS AFFAIRS, DEPARTMENT OF">Veterans Affairs</option>
      <option value="FEDERAL ACQUISITION SERVICE">Federal Acquisition Service (GSA)</option>
      <option value="NATIONAL AERONAUTICS AND SPACE ADMINISTRATION">NASA</option>
      <option value="ENERGY, DEPARTMENT OF">Energy Department</option>
      <option value="CENTERS FOR MEDICARE AND MEDICAID SERVICES">CMS</option>
      <option value="STATE, DEPARTMENT OF">State Department</option>
    </select>
  </div>
  
  <div class="form-group">
    <label class="form-label">Start Date</label>
    <input type="date" id="fpdsStartDate" class="form-input" value="2023-01-01">
  </div>
  
  <div class="form-group">
    <label class="form-label">End Date</label>
    <input type="date" id="fpdsEndDate" class="form-input" value="2025-12-31">
  </div>
  
  <!-- Third Row: Amount and Keywords -->
  <div class="form-group">
    <label class="form-label">Minimum Amount ($)</label>
    <select id="fpdsMinAmount" class="form-select">
      <option value="">Any Amount</option>
      <option value="100000">$100K+</option>
      <option value="500000">$500K+</option>
      <option value="1000000">$1M+</option>
      <option value="5000000">$5M+</option>
      <option value="10000000">$10M+</option>
    </select>
  </div>
  
  <div class="form-group">
    <label class="form-label">Company/Product Keyword</label>
    <input type="text" id="fpdsCompanyKeyword" class="form-input" placeholder="e.g., Microsoft, Salesforce">
  </div>
</div>
  
  <button type="button" class="btn btn-primary" onclick="generateFPDSSearch()">
    <i class="fas fa-search"></i> Generate Search String
  </button>
  
  <!-- Search Output -->
  <div class="search-output-section" id="fpdsSearchOutput">
    <h4 style="color: var(--text-primary); margin-bottom: var(--space);">Your FPDS Search String</h4>
    <textarea class="search-string-display" id="fpdsSearchString" readonly placeholder="Your generated search will appear here..."></textarea>
    
    <div class="search-actions">
      <button class="btn btn-secondary" onclick="copyFPDSSearch()">
        <i class="fas fa-copy"></i> Copy Search
      </button>
      <a href="#" id="directFPDSLink" target="_blank" class="btn btn-primary">
        <i class="fas fa-external-link-alt"></i> Search FPDS Directly
      </a>
      <button class="btn btn-secondary" onclick="showFPDSInstructions()">
        <i class="fas fa-question-circle"></i> How to Use
      </button>
    </div>
    
    <div class="search-preview" id="fpdsSearchPreview"></div>
  </div>
  
  <!-- Instructions Modal -->
  <div class="search-instructions-modal" id="fpdsInstructionsModal">
    <div class="search-instructions-content">
      <h3>How to Use Your Search String</h3>
      <ol>
        <li><strong>Click "Search FPDS Directly"</strong> - This opens FPDS.gov with your search already loaded</li>
        <li><strong>Review the results</strong> - Check that you're getting relevant contracts</li>
        <li><strong>Export to CSV</strong> - Look for the download/export button on FPDS</li>
        <li><strong>Upload to Hoowon</strong> - Come back here and upload your CSV for analysis</li>
        <li><strong>Refine if needed</strong> - Adjust filters and try again</li>
      </ol>
      <p style="margin-top: var(--space); color: var(--text-secondary); font-size: 0.875rem;">
        <strong>Pro tip:</strong> Start with broader searches and narrow down. FPDS has a 30,000 row export limit.
      </p>
      <button class="btn btn-primary" onclick="closeFPDSInstructions()">Got it!</button>
    </div>
  </div>
</section>
      <section class="table-section">
        <div class="tabs"><button class="tab-btn active" data-tab="recent">Recent Awards</button><button class="tab-btn" data-tab="largest">Largest Awards</button><button class="tab-btn" data-tab="offices">Top Offices</button></div>
        <div class="tab-content active" id="recentTab"><table class="data-table" id="recentTable"><thead><tr><th>Date</th><th>Contract ID</th><th>Agency</th><th>Office</th><th>Vendor</th><th>Description</th><th>Value</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
        <div class="tab-content" id="largestTab"><table class="data-table" id="largestTable"><thead><tr><th>Date</th><th>Contract ID</th><th>Agency</th><th>Office</th><th>Vendor</th><th>Description</th><th>Value</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
        <div class="tab-content" id="officesTab"><table class="data-table" id="officesTable"><thead><tr><th>Agency</th><th>Office</th><th>Contracts</th><th>Total Value</th><th>Top NAICS</th><th>Top Vendor</th></tr></thead><tbody></tbody></table></div>
      </section>
    </main>

<footer class="app-footer-enhanced">
  <div class="footer-content">
    <section class="footer-section explainer-section">
      <h3>Turn Contract History Into Sales Intelligence</h3>
      <p>Upload FPDS contract data to see who's buying what, when they buy it, and who's winning. Perfect for competitive intelligence, partner identification, and timing your sales cycles.</p>
      <div class="quick-steps">
        <div class="step-row">
          <span class="step-number">1</span>
          <div class="step-text">
            <strong>Search FPDS:</strong> Go to <a href="https://www.fpds.gov/ezsearch/fpdsportal" target="_blank">FPDS.gov</a> and export CSV results
          </div>
        </div>
        <div class="step-row">
          <span class="step-number">2</span>
          <div class="step-text">
            <strong>Upload & Analyze:</strong> Upload here for instant competitive intelligence visualization
          </div>
        </div>
        <div class="step-row">
          <span class="step-number">3</span>
          <div class="step-text">
            <strong>Filter & Explore:</strong> Click charts to drill down, identify opportunities and threats
          </div>
        </div>
      </div>
    </section>
    <div class="footer-grid-expanded">
      <div class="footer-section">
        <h3>Let's Connect</h3>
        <div class="connect-card-compact">
          <div class="connect-avatar">
            <img src="oldmark.jpg" alt="Mark's profile picture">
          </div>
          <div class="connect-info">
            <h4>Hi, I'm Mark</h4>
            <p>I spent my sales career at AWS, F5, and Red Hat, and before that, I was a DISA COTR. I know one truth most people overlook: historical data is a secret sales weapon. Everyone talks about chasing net new, but the pros know the past shows you where the future is headed.</p>
            <p>That's why I built Hoowon.com. Hoowon helps you see which agencies are spending, who's winning the contracts, and the exact times of year money moves. It's insight you can take straight into customer conversations to make those cold calls a little warmer.</p>
            <p>Want to dig deeper? Let's jump on a quick chat.</p>
            <div class="connect-buttons">
              <a href="https://www.linkedin.com/in/markflournoy/" class="btn btn-secondary btn-sm" target="_blank" rel="noopener"><i class="fab fa-linkedin"></i> Connect</a>
              <a href="mailto:mark@subhoo.com" class="btn btn-secondary btn-sm"><i class="fas fa-envelope"></i> Email</a>
              <a href="https://calendly.com/markflournoy/intro" class="btn btn-secondary btn-sm"><i class="fas fa-calendar"></i> Chat</a>
            </div>
          </div>
        </div>
      </div>
      <div class="footer-section">
        <h3>Who's This For?</h3>
        <div class="user-types">
          <div class="user-type"><strong>Sales Teams:</strong> Stop flying blind into meetings. See seasonal buying patterns and identify which offices have budget authority.</div>
          <div class="user-type"><strong>Business Development:</strong> Scope out competition before wasting time on hopeless deals. See who's winning and what contract vehicles they use.</div>
          <div class="user-type"><strong>Contracting Officers:</strong> New to an agency? See procurement history, successful vendors, and spending patterns instantly.</div>
          <div class="user-type"><strong>Channel Partners:</strong> Find agencies where your OEM partners win direct deals - those are warm prospects for your services.</div>
          <div class="user-type"><strong>Program Managers:</strong> Benchmark spending against similar programs and identify proven vendors in your space.</div>
        </div>
      </div>
      <div class="footer-section">
        <h3>FPDS Search Examples</h3>
        <div class="search-examples-compact">
          <div class="search-example-compact"><strong>IT Services:</strong><code>PRINCIPAL_NAICS_CODE:"541519"</code></div>
          <div class="search-example-compact"><strong>Software:</strong><code>PRINCIPAL_NAICS_CODE:"511210"</code></div>
          <div class="search-example-compact"><strong>Cloud/SaaS:</strong><code>PRINCIPAL_NAICS_CODE:"518210" OR "511210"</code></div>
          <div class="search-example-compact"><strong>Specific Agency:</strong><code>CONTRACTING_AGENCY_NAME:"DEPT OF VETERANS AFFAIRS"</code></div>
          <div class="search-example-compact"><strong>Dollar Range:</strong><code>OBLIGATED_AMOUNT:[1000000,10000000]</code></div>
        </div>
        <h4 style="margin-top: var(--space-lg); margin-bottom: var(--space);">Useful Links</h4>
        <div class="footer-links">
          <a href="https://www.fpds.gov" target="_blank" rel="noopener"><i class="fas fa-external-link-alt"></i> Federal Procurement Data System</a>
          <a href="https://sam.gov" target="_blank" rel="noopener"><i class="fas fa-external-link-alt"></i> SAM.gov Registration</a>
          <a href="https://www.sba.gov" target="_blank" rel="noopener"><i class="fas fa-external-link-alt"></i> Small Business Administration</a>
        </div>
      </div>
    </div>
    <div class="copyright">
      <p>&copy; 2025 Hoowon. All rights reserved. | Historical Contract Intelligence for Federal Sales Teams</p>
    </div>
  </div>
</footer>
  </div>

  <div class="modal-backdrop" id="contractModal">
    <div class="modal">
      <div class="modal-header"><h3>Contract Details</h3><button class="btn btn-sm" id="closeModal">×</button></div>
      <div class="modal-body" id="modalContent"></div>
      <div class="modal-footer"><button class="btn btn-secondary" id="closeModalBtn">Close</button></div>
    </div>
  </div>

<script>
const themeManager = {
  themes: {
    light: {
      cssVars: {
        '--primary': '#1A593A',
        '--primary-dark': '#004225',
        '--primary-text': '#FFFFFF',
        '--text-primary': '#004225',
        '--text-secondary': '#5B7568',
        '--text-tertiary': '#8DA396',
        '--bg-primary': '#F9FAF8',
        '--bg-secondary': '#F0F2EF',
        '--bg-tertiary': '#E8EBE6',
        '--border': '#E8EBE6',
      },
      chartPalette: [
        '#004225', '#1A593A', '#3B7051', '#5B8A6F', 
        '#8DA396', '#B9C9C0', '#DDE6E2', '#F5F8F2'
      ]
    },
    dark: {
      cssVars: {
        '--primary': '#73C69D',
        '--primary-dark': '#5FAA83',
        '--primary-text': '#1B2B23',
        '--text-primary': '#F5F8F2',
        '--text-secondary': '#B9C9C0',
        '--text-tertiary': '#8DA396',
        '--bg-primary': '#1B2B23',
        '--bg-secondary': '#2A3F33',
        '--bg-tertiary': '#3A5143',
        '--border': '#3A5143',
      },
      chartPalette: [
        '#F5F8F2', '#DDE6E2', '#B9C9C0', '#8DA396', 
        '#6DD499', '#5ABF83', '#47AA6F', '#3A8C5A'
      ]
    }
  },
  applyTheme(themeName) {
    const theme = this.themes[themeName];
    if (!theme) {
      console.warn(`Theme "${themeName}" not found.`);
      return;
    }
    for (const [key, value] of Object.entries(theme.cssVars)) {
      document.documentElement.style.setProperty(key, value);
    }
    PALETTE = theme.chartPalette;
    document.querySelectorAll('.theme-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.theme === themeName);
    });
    // Note: localStorage removed for Claude.ai compatibility
    if (app.data.length > 0) {
      if (comparisonManager.isActive) {
          charts.initAll(true); 
          comparisonManager.runComparison();
      } else {
          charts.initAll();
          dashboard.updateCharts();
      }
    }
  },
  init() {
    // Default to dark theme since localStorage is not available
    this.applyTheme('dark');
  }
};

const app = {
  data: [],
  filteredData: [],
  agencies: {},
  offices: {},
  vendors: {},
  naicsCodes: {},
  pscCodes: {},
  charts: {},
  filters: {
    search: null,
    agency: null,
    vendor: null,
    naics: null,
    office: null,
    startDate: null,
    endDate: null,
    valueRange: null
  },
  selection: { type: null, value: null, container: null },
  sankeyDisplayLimit: 10,
  s3BaseUrl: "https://subhoodata.s3.us-east-1.amazonaws.com/data/",
  totalFilteredValue: 0,
  sankeyTotal: 0,
  isUpdating: false,
  parseWarnings: [],
  currentDataSource: null
};

let PALETTE = [];
const chartConfig = { fillOpacity: 0.65, lineOpacity: 0.25, comparisonColorB: '#4A90E2' };
const elements = {};

function cacheElements() {
  const elementIds = [
    'csvFile', 'searchInput', 'agencyFilter', 'vendorFilter',
    'naicsFilter', 'officeFilter', 'valueFilter', 'startDate', 'endDate',
    'resetBtn', 'moreFiltersBtn', 'advancedFilters', 'controlsSection',
    'loadingState', 'errorState', 'emptyState', 'dashboard', 'totalValue',
    'totalContracts', 'totalCompanies', 'topCompany', 'sankeyChart', 'primaryChartTitle', 'sankeyControls',
    'sankeyLimit10', 'sankeyLimit25', 'sankeyLimitAll', 'contractModal',
    'closeModal', 'closeModalBtn', 'modalContent', 'parseWarnings',
    'comparisonControls', 'vendorSelectors', 'toggleComparison', 'closeComparison', 
    'vendorAInput', 'vendorAOptions', 'vendorBInput', 'vendorBOptions', 'runComparison',
    'statCard1', 'statCard2', 'statCard3', 'statCard4'
  ];
  elementIds.forEach(id => {
    elements[id] = document.getElementById(id);
  });
  elements.timelineChart = document.getElementById('timelineChart')?.getContext('2d');
  elements.industryChart = document.getElementById('industryChart')?.getContext('2d');
  elements.recentTable = document.querySelector('#recentTable tbody');
  elements.largestTable = document.querySelector('#largestTable tbody');
  elements.officesTable = document.querySelector('#officesTable tbody');
}

const utils = {
  formatMoney: function(value) {
    if (!value && value !== 0) return '$0';
    const number = parseFloat(value);
    if (isNaN(number)) return '$0';
    const formatNumber = (num) => {
      return num % 1 === 0 ? num.toFixed(0) : num.toFixed(1);
    };
    if (Math.abs(number) >= 1e9) return '$' + formatNumber(number / 1e9) + 'B';
    if (Math.abs(number) >= 1e6) return '$' + formatNumber(number / 1e6) + 'M';
    if (Math.abs(number) >= 1e3) return '$' + formatNumber(number / 1e3) + 'K';
    return '$' + number.toLocaleString(undefined, { maximumFractionDigits: 0 });
  },
  getOpacityHex: function(opacity) {
    if (opacity < 0) opacity = 0;
    if (opacity > 1) opacity = 1;
    const alpha = Math.round(opacity * 255);
    return (alpha < 16 ? '0' : '') + alpha.toString(16).toUpperCase();
  },
  formatDate: function(dateInput) { 
    if (!dateInput) return 'N/A';
    const date = this.parseDate(dateInput);
    return date ? date.toLocaleDateString('en-US', { 
      year: '2-digit', 
      month: 'short', 
      day: 'numeric', 
      timeZone: 'UTC' 
    }) : 'N/A';
  },
  parseMoney: function(value) {
    if (value === null || value === undefined || value === '') return 0;
    const cleanValue = String(value).replace(/[$,\s]/g, '');
    return this.safeParseFloat(cleanValue);
  },
  safeParseFloat: function(value) {
    if (value === null || value === undefined || value === '') return 0;
    const parsed = parseFloat(value);
    return isNaN(parsed) ? 0 : parsed;
  },
  detectDataType: function(value, columnName) {
    if (!value || value === '') return { type: 'string', value: value };
    const str = String(value).trim();
    if (str.match(/^\$?[\d,]+\.?\d*$/)) {
      return { type: 'number', value: this.parseMoney(str) };
    }
    if (str.match(/^\d{1,2}[-\/]\w{3}[-\/]\d{2,4}$/) || 
        str.match(/^\d{4}-\d{2}-\d{2}$/) ||
        str.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
      const parsedDate = this.parseDate(str);
      if (parsedDate) {
        return { type: 'date', value: parsedDate, originalValue: str };
      }
    }
    if (str.match(/^[\d,]+\.?\d*$/) && !isNaN(parseFloat(str.replace(/,/g, '')))) {
      return { type: 'number', value: parseFloat(str.replace(/,/g, '')) };
    }
    if (str.toLowerCase() === 'true' || str.toLowerCase() === 'false') {
      return { type: 'boolean', value: str.toLowerCase() === 'true' };
    }
    return { type: 'string', value: str };
  },
  parseCSV: function(text) {
    if (!text || typeof text !== 'string') {
      return { headers: [], data: [], errors: ['Invalid input: expected string'], warnings: [] };
    }
    const errors = [];
    const warnings = [];
    const lines = [];
    let currentLine = [];
    let currentField = [];
    let inQuotes = false;
    let i = 0;
    let lineNumber = 1;

    while (i < text.length) {
      const char = text[i];
      const nextChar = i + 1 < text.length ? text[i + 1] : '';
      
      if (inQuotes) {
        if (char === '"') {
          if (nextChar === '"') {
            currentField.push('"');
            i += 2;
            continue;
          } else {
            inQuotes = false;
            i++;
            continue;
          }
        } else {
          currentField.push(char);
          if (char === '\n') lineNumber++;
        }
      } else {
        if (char === '"') {
          if (currentField.length > 0) {
            warnings.push(`Unexpected quote at line ${lineNumber}, position ${i}`);
          }
          inQuotes = true;
        } else if (char === ',') {
          currentLine.push(currentField.join('').trim());
          currentField = [];
        } else if (char === '\r' && nextChar === '\n') {
          currentLine.push(currentField.join('').trim());
          lines.push({ line: currentLine, lineNumber });
          currentLine = [];
          currentField = [];
          lineNumber++;
          i++;
        } else if (char === '\r' || char === '\n') {
          currentLine.push(currentField.join('').trim());
          lines.push({ line: currentLine, lineNumber });
          currentLine = [];
          currentField = [];
          lineNumber++;
        } else {
          currentField.push(char);
        }
      }
      i++;
    }

    if (inQuotes) {
      errors.push(`Unclosed quoted field at line ${lineNumber}`);
    }

    if (currentField.length > 0 || currentLine.length > 0) {
      currentLine.push(currentField.join('').trim());
      lines.push({ line: currentLine, lineNumber });
    }

    const nonEmptyLines = lines.filter(lineObj => 
      lineObj.line.length > 0 && lineObj.line.some(field => field.length > 0)
    );

    if (nonEmptyLines.length === 0) {
      return { headers: [], data: [], errors: ['No data found'], warnings };
    }

    const headers = nonEmptyLines[0].line;
    const data = [];
    
    const cleanHeaders = headers.map(header => {
      const cleaned = header.trim();
      if (!cleaned) {
        warnings.push('Empty header field detected and will be replaced');
        return `Column_${headers.indexOf(header)}`;
      }
      return cleaned;
    });

    const headerCount = cleanHeaders.length;

    for (let i = 1; i < nonEmptyLines.length; i++) {
      const lineObj = nonEmptyLines[i];
      const values = lineObj.line;

      if (values.length !== headerCount) {
        warnings.push(`Row ${lineObj.lineNumber}: Expected ${headerCount} fields, got ${values.length}`);
        while (values.length < headerCount) values.push('');
        values.length = headerCount;
      }

      const row = {};
      for (let j = 0; j < headerCount; j++) {
        const rawValue = values[j] || '';
        const typedValue = this.detectDataType(rawValue, cleanHeaders[j]);
        row[cleanHeaders[j]] = rawValue;
        if (typedValue.type !== 'string') {
          row[`${cleanHeaders[j]}_typed`] = typedValue.value;
          row[`${cleanHeaders[j]}_type`] = typedValue.type;
        }
      }
      data.push(row);
    }

    return { headers: cleanHeaders, data, errors, warnings };
  },
  parseDate: function(dateString) {
    if (!dateString) return null;
    if (dateString instanceof Date && !isNaN(dateString)) return dateString;
    const s = String(dateString).trim();
    
    let parts = s.match(/^(\d{1,2})-(\w{3})-(\d{2,4})$/);
    if (parts) {
      const months = {
        'Jan':0,'Feb':1,'Mar':2,'Apr':3,'May':4,'Jun':5,
        'Jul':6,'Aug':7,'Sep':8,'Oct':9,'Nov':10,'Dec':11
      };
      const day = parseInt(parts[1]);
      const month = months[parts[2]];
      let year = parseInt(parts[3]);
      if (year < 100) year = year < 50 ? 2000 + year : 1900 + year;
      if (!isNaN(day) && month !== undefined && !isNaN(year)) {
        return new Date(Date.UTC(year, month, day));
      }
    }
    
    const date = new Date(s);
    if (!isNaN(date.getTime())) {
      const utcDate = new Date(Date.UTC(
        date.getFullYear(), 
        date.getMonth(), 
        date.getDate()
      ));
      return utcDate;
    }
    return null;
  },
  truncateText: function(text, maxLength) {
    if (!text) return '';
    if (typeof text !== 'string') text = String(text);
    if (text.length <= maxLength) return text;
    return text.substring(0, maxLength) + '...';
  },
  getEntityColor: function(entityName) {
    if (!entityName) return PALETTE[0];
    let hash = 0;
    const name = String(entityName);
    for (let i = 0; i < name.length; i++) {
      hash = name.charCodeAt(i) + ((hash << 5) - hash);
    }
    return PALETTE[Math.abs(hash) % PALETTE.length];
  },
  getInitials: function(name) {
    if (!name) return '?'; 
    const nameStr = String(name);
    const words = nameStr.split(/\s+/).filter(word => word.length > 0);
    return words.length > 1 
      ? (words[0].charAt(0) + words[1].charAt(0)).toUpperCase() 
      : nameStr.charAt(0).toUpperCase();
  },
  parseValueRange: function(rangeStr) {
    if (!rangeStr || typeof rangeStr !== 'string') return null;
    const parts = rangeStr.split('-');
    if (parts.length !== 2) return null;
    const min = this.safeParseFloat(parts[0]);
    const max = this.safeParseFloat(parts[1]);
    return { min, max };
  },
  validateContract: function(contract) {
    return contract && 
           typeof contract === 'object' &&
           contract.id &&
           contract.value !== undefined &&
           contract.value !== null;
  }
};

const stateManager = {
  showState: function(state, message = '') {
    const states = ['loadingState', 'errorState', 'emptyState', 'dashboard'];
    states.forEach(s => {
      const el = elements[s];
      if (el) {
        el.classList.toggle('hidden', s !== state);
      }
    });
    
    if (state === 'errorState') {
      if (message && document.getElementById('errorMessage')) {
        document.getElementById('errorMessage').textContent = message;
      }
      if (app.parseWarnings.length > 0 && elements.parseWarnings) {
        elements.parseWarnings.innerHTML = `
          <h4>Parse Warnings:</h4>
          <ul>${app.parseWarnings.map(w => `<li>${w}</li>`).join('')}</ul>
        `;
        elements.parseWarnings.classList.remove('hidden');
      }
    }
    
    if (elements.controlsSection) {
      elements.controlsSection.style.display = state === 'dashboard' ? 'block' : 'none';
    }
  },
  updateFilters: function(filterUpdates, skipSync = false) {
    if (app.isUpdating) return;
    Object.assign(app.filters, filterUpdates);
    if (!skipSync) {
      this.syncFiltersToUI();
    }
    this.applyFilters();
  },
  syncFiltersToUI: function() {
    if (elements.searchInput) {
      elements.searchInput.value = app.filters.search || '';
    }
    if (elements.startDate) {
      elements.startDate.value = app.filters.startDate || '';
    }
    if (elements.endDate) {
      elements.endDate.value = app.filters.endDate || '';
    }
    
    const selectFilters = ['agency', 'vendor', 'naics', 'office'];
    selectFilters.forEach(filter => {
      const element = elements[`${filter}Filter`];
      if (element) {
        element.value = app.filters[filter] || '';
      }
    });
    
    if (elements.valueFilter) {
      if (app.filters.valueRange) {
        const range = app.filters.valueRange;
        const value = `${range.min}-${range.max}`;
        for (let option of elements.valueFilter.options) {
          if (option.value === value) {
            elements.valueFilter.value = value;
            break;
          }
        }
      } else {
        elements.valueFilter.value = '';
      }
    }
  },
  applyFilters: function() {
    if (!app.data || app.data.length === 0) return;
    app.isUpdating = true;
    
    let filtered = [...app.data];
    
    if (app.filters.search) {
      const term = String(app.filters.search).toLowerCase();
      filtered = filtered.filter(item => {
        if (!utils.validateContract(item)) return false;
        return Object.values(item).some(val => {
          if (val === null || val === undefined) return false;
          return String(val).toLowerCase().includes(term);
        });
      });
    }
    
    const entityFilters = ['agency', 'vendor', 'naics', 'office'];
    entityFilters.forEach(field => {
      if (app.filters[field]) {
        filtered = filtered.filter(item => 
          item && item[field] === app.filters[field]
        );
      }
    });
    
    if (app.filters.startDate) {
      const startDate = utils.parseDate(app.filters.startDate);
      if (startDate) {
        filtered = filtered.filter(item => 
          item && item.parsedDate && item.parsedDate >= startDate
        );
      }
    }
    
    if (app.filters.endDate) {
      const endDate = utils.parseDate(app.filters.endDate);
      if (endDate) {
        endDate.setUTCHours(23, 59, 59, 999);
        filtered = filtered.filter(item => 
          item && item.parsedDate && item.parsedDate <= endDate
        );
      }
    }
    
    if (app.filters.valueRange) {
      const range = app.filters.valueRange;
      filtered = filtered.filter(item => {
        if (!item) return false;
        const value = utils.safeParseFloat(item.value);
        return value >= range.min && value <= range.max;
      });
    }
    
    app.filteredData = filtered;
    this.analyzeFilteredData();
    dashboard.updateAll();
    this.updateFilterDisplay();
    
    if (comparisonManager.isActive) {
        comparisonManager.runComparison();
    }
    app.isUpdating = false;
  },
  analyzeFilteredData: function() {
    const data = app.filteredData;
    app.agencies = {};
    app.offices = {};
    app.vendors = {};
    app.naicsCodes = {};
    app.pscCodes = {};
    
    data.forEach(contract => {
      if (!utils.validateContract(contract)) return;
      
      const value = utils.safeParseFloat(contract.value);
      
      if (contract.agency) {
        if (!app.agencies[contract.agency]) {
          app.agencies[contract.agency] = {
            name: contract.agency, 
            count: 0, 
            value: 0
          };
        }
        app.agencies[contract.agency].count++;
        app.agencies[contract.agency].value += value;
      }
      
      if (contract.office) {
        if (!app.offices[contract.office]) {
          app.offices[contract.office] = {
            name: contract.office, 
            agency: contract.agency, 
            count: 0, 
            value: 0, 
            naicsCodes: {}
          };
        }
        app.offices[contract.office].count++;
        app.offices[contract.office].value += value;
        
        if (contract.naics) {
          if (!app.offices[contract.office].naicsCodes[contract.naics]) {
            app.offices[contract.office].naicsCodes[contract.naics] = { count: 0, value: 0 };
          }
          app.offices[contract.office].naicsCodes[contract.naics].count++;
          app.offices[contract.office].naicsCodes[contract.naics].value += value;
        }
      }
      
      if (contract.vendor) {
        if (!app.vendors[contract.vendor]) {
          app.vendors[contract.vendor] = {
            name: contract.vendor, 
            count: 0, 
            value: 0
          };
        }
        app.vendors[contract.vendor].count++;
        app.vendors[contract.vendor].value += value;
      }
      
      if (contract.naics) {
        if (!app.naicsCodes[contract.naics]) {
          app.naicsCodes[contract.naics] = {
            code: contract.naics, 
            description: contract.naicsDescription, 
            count: 0, 
            value: 0
          };
        }
        app.naicsCodes[contract.naics].count++;
        app.naicsCodes[contract.naics].value += value;
      }
      
      if (contract.psc) {
        if (!app.pscCodes[contract.psc]) {
          app.pscCodes[contract.psc] = {
            code: contract.psc, 
            description: contract.pscDescription, 
            count: 0, 
            value: 0
          };
        }
        app.pscCodes[contract.psc].count++;
        app.pscCodes[contract.psc].value += value;
      }
    });
  },
  resetFilters: function() {
    if (comparisonManager.isActive) {
        comparisonManager.clearComparison();
    }
    app.filters = {
      search: null,
      agency: null,
      vendor: null,
      naics: null,
      office: null,
      startDate: null,
      endDate: null,
      valueRange: null
    };
    app.selection = { type: null, value: null, container: null };
    app.filteredData = [...app.data];
    app.sankeyDisplayLimit = 10;
    
    this.analyzeFilteredData();
    sankeyChart.updateButtons('sankeyLimit10');
    dashboard.updateAll();
    
    if (elements.advancedFilters) {
      elements.advancedFilters.classList.remove('active');
    }
    
    this.updateFilterDisplay();
    this.syncFiltersToUI();
  },
  applySelectionFilter: function(type, value) {
    if (app.filters[type] === value) {
      const updates = { [type]: null };
      if (type === 'agency') {
        updates.office = null;
      }
      this.updateFilters(updates);
      return;
    }
    
    const updates = { [type]: value };
    if (type === 'office') {
      const parentAgency = app.offices[value]?.agency;
      if (parentAgency && parentAgency !== app.filters.agency) {
        updates.agency = parentAgency;
      }
    } else if (type === 'agency') {
      if (app.filters.office) {
        const currentOfficeAgency = app.offices[app.filters.office]?.agency;
        if (currentOfficeAgency !== value) {
          updates.office = null;
        }
      }
    }
    this.updateFilters(updates);
  },
  updateFilterDisplay() {
    const displayElement = document.getElementById('filterDisplay');
    if (!displayElement) return;
    
    const parts = [];
    const filters = app.filters;
    
    if (filters.agency) {
      parts.push(`<strong>${utils.truncateText(filters.agency, 40)}</strong>`);
    }
    if (filters.office) {
      parts.push(`<strong>${utils.truncateText(filters.office, 40)}</strong>`);
    }
    if (filters.vendor) {
      parts.push(`<strong>${utils.truncateText(filters.vendor, 40)}</strong>`);
    }
    if (filters.naics) {
      parts.push(`<strong>${filters.naics}</strong>`);
    }
    
    displayElement.innerHTML = parts.length > 0 
      ? `Filtering by: ${parts.join(' &nbsp;|&nbsp; ')}`
      : '<em></em>';
  }
};

const dataProcessor = {
  async loadExampleData(dataset = 'it-software') {
    try {
      stateManager.showState('loadingState');
      const datasetMap = {
        '541519_Other_Computer': '541519_Other_Computer.csv',
        '511210_Software_Publishers': '511210_Software_Publishers.csv', 
        '334111_Electronic_Computer': '334111_Electronic_Computer.csv',
        'DISA_CY24_25': 'DISA_CY24_25.csv',
        'dhs_CY24_25': 'dhs_CY24_25.csv',
		'NAICS_611310_Colleges': 'NAICS_611310_Colleges.csv',
		'USAF_SEP24': 'USAF_SEP24.csv',
		'PSC_DA10_SaaS': 'PSC_DA10_SaaS.csv',
		'PSC_DA01_IT_Labor': 'PSC_DA01_IT_Labor.csv',
        '332813_Electroplating': '332813_Electroplating.csv'
      };
      
      const filename = datasetMap[dataset] || datasetMap['it-software'];
      const response = await fetch(`${app.s3BaseUrl}${filename}`);
      
      if (!response.ok) {
        throw new Error(`Failed to load ${dataset} data (Status: ${response.status})`);
      }
      
      const csvText = await response.text();
      this.processData(csvText);
    } catch (error) {
      console.error('Load error:', error);
      stateManager.showState('errorState', error.message);
    }
  },
  
  processData(csvText) {
    try {
      stateManager.showState('loadingState');
      
      if(comparisonManager.isActive) {
        comparisonManager.clearComparison();
      }
      
      let csvData;
      try {
        csvData = utils.parseCSV(csvText);
      } catch (parseError) {
        throw new Error(`CSV parsing failed: ${parseError.message}`);
      }
      
      app.parseWarnings = csvData.warnings || [];
      
      if (csvData.errors && csvData.errors.length > 0) {
        throw new Error(`CSV errors: ${csvData.errors.join(', ')}`);
      }
      
      const requiredFields = [
        'Contract ID', 'Date Signed', 'Contracting Agency', 
        'Legal Business Name', 'Action Obligation ($)'
      ];
      
      for (const field of requiredFields) {
        if (!csvData.headers.includes(field)) {
          throw new Error(
            `Required field "${field}" not found in CSV. Available fields: ${csvData.headers.join(', ')}`
          );
        }
      }
      
      app.data = csvData.data
        .map((row, index) => {
          try {
            const parsedDate = utils.parseDate(row['Date Signed']);
            const value = utils.parseMoney(row['Action Obligation ($)']);
            
            return {
              id: String(row['Contract ID'] || ''),
              reference: String(row['Reference IDV'] || ''),
              modification: String(row['Modification Number'] || ''),
              date: String(row['Date Signed'] || ''),
              parsedDate: parsedDate,
              type: String(row['Award/IDV Type'] || ''),
              agency: String(row['Contracting Agency'] || ''),
              office: String(row['Contracting Office Name'] || ''),
              vendor: String(row['Legal Business Name'] || ''),
              value: value,
              naics: String(row['NAICS'] || ''),
              naicsDescription: String(row['NAICS Description'] || ''),
              psc: String(row['PSC'] || ''),
              pscDescription: String(row['PSC Description'] || ''),
              description: String(row['PSC Description'] || row['Description of Requirement'] || '')
            };
          } catch (rowError) {
            console.warn(`Error processing row ${index + 1}:`, rowError);
            return null;
          }
        })
        .filter(row => row !== null && utils.validateContract(row));
      
      if (app.data.length === 0) {
        throw new Error('No valid data rows could be processed');
      }
      
      app.filteredData = [...app.data];
      app.filters = {
        search: null,
        agency: null,
        vendor: null,
        naics: null,
        office: null,
        startDate: null,
        endDate: null,
        valueRange: null
      };
      
      stateManager.analyzeFilteredData();
      this.populateFilters();
      
      if (app.parseWarnings.length > 0) {
        console.warn('CSV Parse Warnings:', app.parseWarnings);
      }
      
      stateManager.showState('dashboard');
      sankeyChart.updateButtons('sankeyLimit10');
      charts.initAll();
      dashboard.updateAll();
      stateManager.updateFilterDisplay();
      stateManager.syncFiltersToUI();
      
      if (elements.comparisonControls) {
        elements.comparisonControls.style.display = 'block';
        comparisonManager.cacheAllVendors();
      }
    } catch (error) {
      console.error('Processing error:', error);
      stateManager.showState('errorState', error.message);
    }
  },
  
  populateFilters() {
    this.populateSelect('agencyFilter', app.agencies);
    this.populateSelect('vendorFilter', app.vendors);
    this.populateSelect('naicsFilter', app.naicsCodes);
    this.populateSelect('officeFilter', app.offices);
  },
  
  populateSelect(selectId, data) {
    const select = elements[selectId];
    if (!select) return;
    
    const currentVal = select.value;
    while (select.options.length > 1) {
      select.remove(1);
    }
    
    const sortedData = Object.values(data)
      .filter(item => item && (item.name || item.code))
      .sort((a, b) => (b.count || 0) - (a.count || 0))
      .slice(0, 200);
    
    sortedData.forEach(item => {
      const option = document.createElement('option');
      option.value = item.name || item.code;
      option.textContent = `${utils.truncateText(item.name || item.code, 40)} (${(item.count || 0).toLocaleString()})`;
      select.appendChild(option);
    });
    
    select.value = currentVal;
  }
};

const charts = {
  centerTextPlugin: {
    id: 'centerText',
    afterDraw: function(chart) {
      if (chart.config.type !== 'doughnut') return;
      
      const ctx = chart.ctx;
      const chartArea = chart.chartArea;
      
      if (chartArea.width <= 0 || chartArea.height <= 0) return;
      
      const centerX = (chartArea.left + chartArea.right) / 2;
      const centerY = (chartArea.top + chartArea.bottom) / 2;
      
      const totalValue = app.totalFilteredValue;
      const valueText = utils.formatMoney(totalValue);
      const labelText = 'Total Value';
      
      const innerRadius = chart.getDatasetMeta(0).data[0]?.innerRadius || chart.width / 4;
      const valueFontSize = Math.min((innerRadius * 2) / 4.5, 32);
      const labelFontSize = Math.min((innerRadius * 2) / 10, 14);
      
      ctx.save();
      ctx.font = `600 ${valueFontSize}px ${Chart.defaults.font.family}`;
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-primary');
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(valueText, centerX, centerY - (labelFontSize / 1.5));
      
      ctx.font = `500 ${labelFontSize}px ${Chart.defaults.font.family}`;
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary');
      ctx.fillText(labelText, centerX, centerY + (valueFontSize / 2.5));
      
      ctx.restore();
    }
  },
  
  initAll(skipUpdate = false) {
    Object.values(app.charts).forEach(chart => {
      if (chart && typeof chart.destroy === 'function') chart.destroy();
    });
    app.charts = {};
    
    if (window.Chart) {
      Chart.defaults.font.family = "'Atkinson Hyperlegible Next', sans-serif";
      Chart.defaults.font.size = 12;
      Chart.defaults.color = getComputedStyle(document.documentElement).getPropertyValue('--text-primary');
    }
    
    this.initTimelineChart();
    this.initIndustryChart();
    
    if(!skipUpdate) {
        sankeyChart.init();
    }
  },
  
  initTimelineChart() {
    if (!elements.timelineChart) return;
    
    const timelineColor = PALETTE[2];
    const fillOpacityHex = utils.getOpacityHex(chartConfig.fillOpacity);
    
    app.charts.timeline = new Chart(elements.timelineChart, {
      type: 'line',
      data: { 
        labels: [], 
        datasets: [{ 
          data: [], 
          borderColor: `transparent`, 
          borderWidth: 0.5,    
          backgroundColor: `${timelineColor}${fillOpacityHex}`,
          tension: 0.4, 
          fill: true,
          pointRadius: 0,
          pointHoverRadius: 3
        }] 
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { 
          legend: { display: false },
          tooltip: { 
            callbacks: { 
              label: c => utils.formatMoney(c.raw) 
            } 
          }
        },
        scales: {
          x: { grid: { display: false } },
          y: { 
            beginAtZero: true, 
            grid: { display: false },
            ticks: { callback: v => utils.formatMoney(v) }
          }
        }
      }
    });
  },
  
  initIndustryChart() {
    if (!elements.industryChart) return;
    
    if (app.charts.industry && typeof app.charts.industry.destroy === 'function') {
        app.charts.industry.destroy();
    }
    
    app.charts.industry = new Chart(elements.industryChart, {
      type: 'doughnut',
      data: { 
        labels: [], 
        datasets: [{ 
          data: [], 
          backgroundColor: [], 
          borderColor: [],
          borderWidth: 0.5,
          originalLabels: [] 
        }] 
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom' },
          tooltip: { 
            callbacks: { 
              label: function(context) {
                const label = context.label || '';
                const value = utils.formatMoney(context.raw);
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = total > 0 ? ((context.raw / total) * 100).toFixed(1) : '0';
                return `${label}: ${value} (${percentage}%)`;
              }
            }
          }
        },
        onClick: (event, activeElements) => {
          if (activeElements.length > 0) {
            const index = activeElements[0].index;
            const naicsCode = app.charts.industry.data.datasets[0].originalLabels[index];
            if (naicsCode) {
              stateManager.applySelectionFilter('naics', naicsCode);
            }
          }
        }
      },
      plugins: [this.centerTextPlugin]
    });
  },
  
  updateTimeline() {
    const chart = app.charts.timeline;
    if (!chart || !app.filteredData || comparisonManager.isActive) return;
    
    const monthlyData = {};
    app.filteredData.forEach(contract => {
      if (contract && contract.parsedDate) {
        const key = `${contract.parsedDate.getUTCFullYear()}-${(contract.parsedDate.getUTCMonth() + 1).toString().padStart(2, '0')}`;
        monthlyData[key] = (monthlyData[key] || 0) + utils.safeParseFloat(contract.value);
      }
    });
    
    const sortedMonths = Object.keys(monthlyData).sort();
    
    chart.data.labels = sortedMonths.map(month => {
      const [year, monthNum] = month.split('-');
      return new Date(Date.UTC(parseInt(year), parseInt(monthNum) - 1))
        .toLocaleDateString('en-US', {
          month: 'short', 
          year: '2-digit', 
          timeZone: 'UTC'
        });
    });
    
    chart.data.datasets[0].data = sortedMonths.map(month => monthlyData[month] || 0);
    chart.update('none');
  },
  
  updateIndustry() {
    const chart = app.charts.industry;
    if (!chart || !app.naicsCodes || comparisonManager.isActive || chart.config.type !== 'doughnut') return;
    
    const naicsArray = Object.values(app.naicsCodes)
      .filter(naics => naics && naics.value > 0)
      .sort((a, b) => (b.value || 0) - (a.value || 0))
      .slice(0, 6);
    
    if (naicsArray.length === 0) {
      chart.data.labels = [];
      chart.data.datasets[0].data = [];
      chart.data.datasets[0].backgroundColor = [];
      chart.data.datasets[0].borderColor = [];
      chart.data.datasets[0].originalLabels = [];
      chart.update('none');
      return;
    }
    
    const solidColors = naicsArray.map(naics => utils.getEntityColor(naics.code));
    const fillOpacityHex = utils.getOpacityHex(chartConfig.fillOpacity);
    
    chart.data.labels = naicsArray.map(naics => 
      `${naics.code} - ${utils.truncateText(naics.description || '', 20)}`
    );
    chart.data.datasets[0].originalLabels = naicsArray.map(naics => naics.code);
    chart.data.datasets[0].data = naicsArray.map(naics => naics.value || 0);
    chart.data.datasets[0].backgroundColor = solidColors.map(color => `${color}${fillOpacityHex}`);
    chart.data.datasets[0].borderColor = solidColors;
    
    chart.update('none');
  }
};

const sankeyChart = {
  init() {
    this.update();
  },
  
  update() {
    if (!elements.sankeyChart || !window.d3 || comparisonManager.isActive) {
      if (comparisonManager.isActive) return;
      elements.sankeyChart.innerHTML = '';
      return;
    };
    
    elements.sankeyChart.innerHTML = '';
    
    const data = this.generateData();
    if (!data.nodes.length || !data.links.length) {
      elements.sankeyChart.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary);">
          No relationships found. Try another filter combo.
        </div>
      `;
      return;
    }
    
    const width = elements.sankeyChart.clientWidth;
    const height = elements.sankeyChart.clientHeight;
    
    const svg = d3.select(elements.sankeyChart).append('svg')
      .attr('width', width)
      .attr('height', height);
    
    const sankey = d3.sankey()
      .nodeWidth(15)
      .nodePadding(10)
      .extent([[1, 5], [width - 1, height - 5]]);
    
    const {nodes, links} = sankey({
      nodes: data.nodes.map(d => Object.assign({}, d)),
      links: data.links.map(d => Object.assign({}, d))
    });
    
    app.sankeyTotal = app.filteredData
      .filter(c => c && c.vendor && data.vendorNames.has(c.vendor))
      .reduce((sum, c) => sum + utils.safeParseFloat(c.value), 0);
    
    this.renderLinks(svg, links);
    this.renderNodes(svg, nodes);
    this.renderLabels(svg, nodes, width);
  },
  
  renderLinks(svg, links) {
    const defs = svg.append('defs');
    
    links.forEach((link, i) => {
      const gradient = defs.append('linearGradient')
        .attr('id', `gradient-${i}`)
        .attr('gradientUnits', 'userSpaceOnUse')
        .attr('x1', link.source.x1)
        .attr('x2', link.target.x0);
      
      gradient.append('stop')
        .attr('offset', '0%')
        .attr('stop-color', utils.getEntityColor(link.source.name));
      
      gradient.append('stop')
        .attr('offset', '100%')
        .attr('stop-color', utils.getEntityColor(link.target.name));
      
      link.gradientId = `gradient-${i}`;
    });
    
    svg.append('g')
      .selectAll('path')
      .data(links)
      .join('path')
      .attr('d', d3.sankeyLinkHorizontal())
      .attr('stroke', d => `url(#${d.gradientId})`)
      .attr('stroke-width', d => Math.max(1, d.width))
      .attr('fill', 'none')
      .attr('stroke-opacity', chartConfig.lineOpacity)
      .append('title')
      .text(d => `${d.source.name} → ${d.target.name}\n${utils.formatMoney(d.value)}`);
  },
  
  renderNodes(svg, nodes) {
    svg.append('g')
      .selectAll('rect')
      .data(nodes)
      .join('rect')
      .attr('x', d => d.x0)
      .attr('y', d => d.y0)
      .attr('height', d => d.y1 - d.y0)
      .attr('width', d => d.x1 - d.x0)
      .attr('fill', d => utils.getEntityColor(d.name))
      .attr('fill-opacity', chartConfig.fillOpacity)
      .attr('rx', 2)
      .style('cursor', 'pointer')
      .on('click', (event, d) => {
        let filterType = null;
        if (app.agencies[d.name]) filterType = 'agency';
        else if (app.offices[d.name]) filterType = 'office';
        else if (app.vendors[d.name]) filterType = 'vendor';
        
        if (filterType) {
          stateManager.applySelectionFilter(filterType, d.name);
        }
      })
      .append('title')
      .text(d => `${d.name}\n${utils.formatMoney(d.value)}`);
  },
  
  renderLabels(svg, nodes, width) {
    const isMobile = window.innerWidth <= 768;
    const fontSize = isMobile ? '10px' : '12px';
    const maxChars = isMobile ? 15 : 25;
    
    svg.append('g')
      .selectAll('text')
      .data(nodes)
      .join('text')
      .attr('x', d => {
        if (isMobile) {
          return d.x0 < width / 2 ? d.x1 + 4 : d.x0 - 4;
        }
        return d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6;
      })
      .attr('y', d => (d.y1 + d.y0) / 2)
      .attr('dy', '0.35em')
      .attr('text-anchor', d => d.x0 < width / 2 ? 'start' : 'end')
      .attr('font-size', fontSize)
      .attr('fill', 'var(--text-primary)')
      .text(d => utils.truncateText(d.name, maxChars));
  },
  
  generateData() {
    if (!app.filteredData || app.filteredData.length === 0) {
      return { nodes: [], links: [], vendorNames: new Set() };
    }
    
    const isMobile = window.innerWidth <= 768;
    const isTablet = window.innerWidth <= 1024;
    
    let vendorLimit = app.sankeyDisplayLimit;
    let officeLimit = 25;
    let agencyLimit = 15;
    
    if (isMobile) {
      vendorLimit = Math.min(app.sankeyDisplayLimit > 0 ? app.sankeyDisplayLimit : 10, 5);
      officeLimit = 8;
      agencyLimit = 5;
    } else if (isTablet) {
      vendorLimit = Math.min(app.sankeyDisplayLimit > 0 ? app.sankeyDisplayLimit : 10, 8);
      officeLimit = 15;
      agencyLimit = 10;
    }
    
    const vendorTotals = {};
    app.filteredData.forEach(contract => {
      if (contract && contract.vendor && utils.safeParseFloat(contract.value) > 0) {
        const vendor = contract.vendor;
        const value = utils.safeParseFloat(contract.value);
        vendorTotals[vendor] = (vendorTotals[vendor] || 0) + value;
      }
    });
    
    if (Object.keys(vendorTotals).length === 0) {
      return { nodes: [], links: [], vendorNames: new Set() };
    }
    
    const sortedVendors = Object.keys(vendorTotals)
      .sort((a, b) => vendorTotals[b] - vendorTotals[a]);
    
    const actualVendorLimit = vendorLimit > 0 ? Math.min(vendorLimit, sortedVendors.length) : sortedVendors.length;
    const topVendorNames = new Set(sortedVendors.slice(0, actualVendorLimit));
    
    const topVendorContracts = app.filteredData.filter(c => 
      c && c.vendor && topVendorNames.has(c.vendor)
    );
    
    const relevantOfficeTotals = {};
    const relevantAgencyTotals = {};
    
    topVendorContracts.forEach(c => {
      const value = utils.safeParseFloat(c.value);
      if (c.office && value > 0) {
        relevantOfficeTotals[c.office] = (relevantOfficeTotals[c.office] || 0) + value;
      }
      if (c.agency && value > 0) {
        relevantAgencyTotals[c.agency] = (relevantAgencyTotals[c.agency] || 0) + value;
      }
    });
    
    const sortedRelevantOffices = Object.keys(relevantOfficeTotals)
      .sort((a, b) => relevantOfficeTotals[b] - relevantOfficeTotals[a]);
    const topOfficeNames = new Set(sortedRelevantOffices.slice(0, officeLimit));
    
    const sortedRelevantAgencies = Object.keys(relevantAgencyTotals)
      .sort((a, b) => relevantAgencyTotals[b] - relevantAgencyTotals[a]);
    const topAgencyNames = new Set(sortedRelevantAgencies.slice(0, agencyLimit));
    
    const agencyOfficeFlows = {};
    const officeVendorFlows = {};
    
    topVendorContracts.forEach(contract => {
      if (!contract.agency || !contract.office || !contract.vendor) return;
      
      const value = utils.safeParseFloat(contract.value);
      if (value <= 0) return;
      
      if (topAgencyNames.has(contract.agency) &&
          topOfficeNames.has(contract.office) &&
          topVendorNames.has(contract.vendor)) {
        
        const aoKey = `${contract.agency}|${contract.office}`;
        agencyOfficeFlows[aoKey] = (agencyOfficeFlows[aoKey] || 0) + value;
        
        const ovKey = `${contract.office}|${contract.vendor}`;
        officeVendorFlows[ovKey] = (officeVendorFlows[ovKey] || 0) + value;
      }
    });
    
    const sortedAgencyOfficeFlows = Object.entries(agencyOfficeFlows)
      .sort(([,a], [,b]) => b - a);
    
    const sortedOfficeVendorFlows = Object.entries(officeVendorFlows)
      .sort(([,a], [,b]) => b - a);
    
    const allFlows = [
      ...sortedAgencyOfficeFlows.map(([key, value]) => ({
        source: key.split('|')[0],
        target: key.split('|')[1],
        value
      })),
      ...sortedOfficeVendorFlows.map(([key, value]) => ({
        source: key.split('|')[0],
        target: key.split('|')[1],
        value
      }))
    ];
    
    if (allFlows.length === 0) {
      return { nodes: [], links: [], vendorNames: topVendorNames };
    }
    
    const nodeMap = new Map();
    allFlows.forEach(flow => {
      if (!nodeMap.has(flow.source)) {
        nodeMap.set(flow.source, { name: flow.source });
      }
      if (!nodeMap.has(flow.target)) {
        nodeMap.set(flow.target, { name: flow.target });
      }
    });
    
    const nodesArray = Array.from(nodeMap.values());
    const nodeIndexMap = new Map(nodesArray.map((node, i) => [node.name, i]));
    
    const links = allFlows
      .map(flow => ({
        source: nodeIndexMap.get(flow.source),
        target: nodeIndexMap.get(flow.target),
        value: flow.value
      }))
      .filter(link => 
        link.source !== undefined && 
        link.target !== undefined && 
        link.source !== link.target &&
        link.value > 0
      );
    
    return { 
      nodes: nodesArray, 
      links, 
      vendorNames: topVendorNames 
    };
  },
  
  updateButtons(activeId) {
    const buttons = document.querySelectorAll('.chart-controls .btn');
    buttons.forEach(btn => {
      btn.classList.toggle('btn-primary', btn.id === activeId);
      btn.classList.toggle('btn-secondary', btn.id !== activeId);
    });
  }
};

const dashboard = {
  updateAll() {
    if(comparisonManager.isActive) {
        comparisonManager.runComparison();
    } else {
        this.updateStats();
        this.updateCharts();
    }
    this.updateTables();
  },
  
  updateStats() {
    if(comparisonManager.isActive) return;
    
    app.totalFilteredValue = app.filteredData.reduce((sum, item) => {
      return sum + utils.safeParseFloat(item ? item.value : 0);
    }, 0);
    
    const totalContracts = app.filteredData.length;
    const uniqueCompanies = new Set(
      app.filteredData
        .filter(item => item && item.vendor)
        .map(item => item.vendor)
    ).size;
    
    const topCompany = Object.values(app.vendors)
      .filter(vendor => vendor && vendor.value > 0)
      .sort((a, b) => (b.value || 0) - (a.value || 0))[0];
    
    elements.statCard1.innerHTML = `<div class="stat-label">Total Value</div><div class="stat-value" id="totalValue">${utils.formatMoney(app.totalFilteredValue)}</div>`;
    elements.statCard2.innerHTML = `<div class="stat-label">Contracts</div><div class="stat-value" id="totalContracts">${totalContracts.toLocaleString()}</div>`;
    elements.statCard3.innerHTML = `<div class="stat-label">Companies</div><div class="stat-value" id="totalCompanies">${uniqueCompanies.toLocaleString()}</div>`;
    elements.statCard4.innerHTML = `<div class="stat-label">Market Leader</div><div class="stat-company" id="topCompany">${utils.truncateText(topCompany?.name || 'N/A', 20)}</div>`;
  },
  
  updateCharts() {
    if (comparisonManager.isActive) return;
    charts.updateTimeline();
    charts.updateIndustry();
    sankeyChart.update();
  },
  
  updateTables() {
    this.updateTable('recent', 
      [...app.filteredData]
        .sort((a, b) => {
          const dateA = a?.parsedDate?.getTime() || 0;
          const dateB = b?.parsedDate?.getTime() || 0;
          return dateB - dateA;
        })
        .slice(0, 15)
    );
    
    this.updateTable('largest', 
      [...app.filteredData]
        .sort((a, b) => utils.safeParseFloat(b?.value) - utils.safeParseFloat(a?.value))
        .slice(0, 15)
    );
    
    this.updateOfficesTable();
    
    if (window.innerWidth <= 768) {
        eventListeners.setupTableScrollIndicators();
    }
  },
  
  updateTable(type, data) {
    const tbody = elements[`${type}Table`];
    if (!tbody) return;
    
    tbody.innerHTML = '';
    data.forEach(contract => {
      if (utils.validateContract(contract)) {
        const row = this.createTableRow(contract);
        tbody.appendChild(row);
      }
    });
  },
  
  createTableRow(contract) {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${utils.formatDate(contract.date)}</td>
      <td>${utils.truncateText(contract.id, 12)}</td>
      <td>
        <div class="entity-badge">
          <div class="entity-icon" style="background-color: ${utils.getEntityColor(contract.agency)}">
            ${utils.getInitials(contract.agency)}
          </div>
          ${utils.truncateText(contract.agency, 20)}
        </div>
      </td>
      <td>${utils.truncateText(contract.office, 20)}</td>
      <td>
        <div class="entity-badge">
          <div class="entity-icon" style="background-color: ${utils.getEntityColor(contract.vendor)}">
            ${utils.getInitials(contract.vendor)}
          </div>
          ${utils.truncateText(contract.vendor, 20)}
        </div>
      </td>
      <td class="truncate" title="${contract.description || ''}">${utils.truncateText(contract.description, 30)}</td>
      <td class="text-right">${utils.formatMoney(contract.value)}</td>
      <td><button class="btn btn-sm btn-secondary view-details-btn" data-contract-id="${contract.id}">View</button></td>
    `;
    return row;
  },
  
  updateOfficesTable() {
    const tbody = elements.officesTable;
    if (!tbody) return;
    
    const top15 = Object.values(app.offices)
      .filter(office => office && office.value > 0)
      .sort((a, b) => (b.value || 0) - (a.value || 0))
      .slice(0, 15);
    
    tbody.innerHTML = '';
    
    top15.forEach(office => {
      const topNaics = Object.values(office.naicsCodes || {})
        .sort((a, b) => (b.value || 0) - (a.value || 0))[0] || { code: 'N/A' };
      
      const officeContracts = app.filteredData.filter(c => 
        c && c.office === office.name
      );
      
      const vendorValues = {};
      officeContracts.forEach(c => {
        if (c && c.vendor) {
          const value = utils.safeParseFloat(c.value);
          vendorValues[c.vendor] = (vendorValues[c.vendor] || 0) + value;
        }
      });
      
      const topVendorName = Object.entries(vendorValues)
        .sort((a, b) => b[1] - a[1])[0]?.[0] || 'N/A';
      
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>
          <div class="entity-badge">
            <div class="entity-icon" style="background-color: ${utils.getEntityColor(office.agency)}">
              ${utils.getInitials(office.agency)}
            </div>
            ${utils.truncateText(office.agency, 15)}
          </div>
        </td>
        <td>
          <div class="entity-badge">
            <div class="entity-icon" style="background-color: ${utils.getEntityColor(office.name)}">
              ${utils.getInitials(office.name)}
            </div>
            ${utils.truncateText(office.name, 15)}
          </div>
        </td>
        <td>${(office.count || 0).toLocaleString()}</td>
        <td class="text-right">${utils.formatMoney(office.value)}</td>
        <td>${topNaics.code || 'N/A'}</td>
        <td>
          <div class="entity-badge">
            <div class="entity-icon" style="background-color: ${utils.getEntityColor(topVendorName)}">
              ${utils.getInitials(topVendorName)}
            </div>
            ${utils.truncateText(topVendorName, 15)}
          </div>
        </td>
      `;
      tbody.appendChild(row);
    });
  }
};

const modal = {
  show(contractId) {
    const contract = app.data.find(c => c && c.id === contractId);
    if (!contract) return;
    
    const fpdsUrl = `https://www.fpds.gov/ezsearch/fpdsportal?q=PIID%3A%22${encodeURIComponent(contract.id)}%22`;
    
    if (elements.modalContent) {
      elements.modalContent.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--space-lg);">
          <div>
            <h4 style="color: var(--text-primary); margin-bottom: var(--space);">Contract Information</h4>
            <p><strong>Contract ID:</strong> ${contract.id || 'N/A'}</p>
            <p><strong>Reference IDV:</strong> ${contract.reference || 'N/A'}</p>
            <p><strong>Date Signed:</strong> ${utils.formatDate(contract.date)}</p>
            <p><strong>Value:</strong> ${utils.formatMoney(contract.value)}</p>
          </div>
          <div>
            <h4 style="color: var(--text-primary); margin-bottom: var(--space);">Parties Involved</h4>
            <p><strong>Agency:</strong> ${contract.agency || 'N/A'}</p>
            <p><strong>Office:</strong> ${contract.office || 'N/A'}</p>
            <p><strong>Vendor:</strong> ${contract.vendor || 'N/A'}</p>
          </div>
        </div>
        <div style="margin-top: var(--space-lg);">
          <h4 style="color: var(--text-primary); margin-bottom: var(--space);">Description & Codes</h4>
          <p><strong>Description:</strong> ${contract.description || 'No description available'}</p>
          <p><strong>NAICS:</strong> ${contract.naics || 'N/A'} - ${contract.naicsDescription || ''}</p>
          <p><strong>PSC:</strong> ${contract.psc || 'N/A'} - ${contract.pscDescription || ''}</p>
        </div>
        <div style="margin-top: var(--space-lg); text-align: center;">
          <a href="${fpdsUrl}" target="_blank" rel="noopener noreferrer" class="btn btn-primary">
            View on FPDS.gov
          </a>
        </div>
      `;
    }
    
    if (elements.contractModal) {
      elements.contractModal.classList.add('active');
    }
  },
  
  close() {
    if (elements.contractModal) {
      elements.contractModal.classList.remove('active');
    }
  }
};

const comparisonManager = {
  isActive: false,
  vendorA: null,
  vendorB: null,
  allVendors: [],
  isLoading: false,
  
  showLoading(container, message = 'Loading comparison...') {
    const loadingHtml = `
      <div class="comparison-loading">
        <div class="loading-spinner"></div>
        <span>${message}</span>
      </div>
    `;
    if (typeof container === 'string') {
      document.getElementById(container).innerHTML = loadingHtml;
    } else {
      container.innerHTML = loadingHtml;
    }
  },
  
  showError(container, title, message, showRetry = false) {
    const retryButton = showRetry ? 
      '<button class="btn btn-sm btn-secondary" onclick="comparisonManager.runComparison()">Try Again</button>' : '';
    
    const errorHtml = `
      <div class="comparison-error">
        <h4>${title}</h4>
        <p>${message}</p>
        ${retryButton}
      </div>
    `;
    
    if (typeof container === 'string') {
      document.getElementById(container).innerHTML = errorHtml;
    } else {
      container.innerHTML = errorHtml;
    }
  },
  
  validateVendorData(vendorA, vendorB) {
    const errors = [];
    
    if (!vendorA || vendorA.length === 0) {
      errors.push(`${this.vendorA} has no contracts in the current filter`);
    }
    
    if (!vendorB || vendorB.length === 0) {
      errors.push(`${this.vendorB} has no contracts in the current filter`);
    }
    
    if (vendorA.length > 0 && vendorB.length > 0) {
      // Check for agency overlap
      const agenciesA = new Set(vendorA.map(c => c.agency));
      const agenciesB = new Set(vendorB.map(c => c.agency));
      const overlap = [...agenciesA].filter(x => agenciesB.has(x));
      
      if (overlap.length === 0) {
        errors.push('These vendors have no competing agencies in common');
      }
    }
    
    return errors;
  },
  
  toggleMode() {
    this.isActive = !this.isActive;
    elements.vendorSelectors.classList.toggle('hidden', !this.isActive);
    elements.closeComparison.classList.toggle('hidden', !this.isActive);
    
    if (this.isActive) {
        elements.toggleComparison.classList.add('btn-primary');
        elements.toggleComparison.classList.remove('btn-secondary');
    } else {
        this.clearComparison();
    }
  },
  
  cacheAllVendors() {
    this.allVendors = Object.values(app.vendors)
        .sort((a, b) => (b.value || 0) - (a.value || 0))
        .map(v => ({ name: v.name, value: v.value }));
    this.populateComboBox('A');
    this.populateComboBox('B');
  },
  
  populateComboBox(vendorType) {
      const optionsContainer = elements[`vendor${vendorType}Options`];
      optionsContainer.innerHTML = '';
      
      const otherVendor = vendorType === 'A' ? this.vendorB : this.vendorA;
      
      this.allVendors.forEach(vendor => {
          if (vendor.name === otherVendor) return;
          
          const option = document.createElement('div');
          option.className = 'combo-box-option';
          option.dataset.value = vendor.name;
          option.innerHTML = `${vendor.name} <span style="color: var(--text-secondary); font-size: 0.8em;">(${utils.formatMoney(vendor.value)})</span>`;
          option.addEventListener('mousedown', () => {
              this.selectOption(vendorType, vendor.name);
          });
          optionsContainer.appendChild(option);
      });
  },
  
  selectOption(vendorType, vendorName) {
    this[`vendor${vendorType}`] = vendorName;
    const input = elements[`vendor${vendorType}Input`];
    input.value = vendorName;
    input.style.borderColor = '';
    input.placeholder = `Vendor ${vendorType} selected`;
    
    document.getElementById(`vendor${vendorType}ComboBox`).classList.remove('open');
    
    this.populateComboBox(vendorType === 'A' ? 'B' : 'A');
    this.filterComboBox(vendorType, '');
    
    // Clear any existing error display if both vendors are now selected
    if (this.vendorA && this.vendorB && this.vendorA !== this.vendorB) {
      const errorDisplay = elements.sankeyChart.querySelector('.comparison-error');
      if (errorDisplay) {
        elements.sankeyChart.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary);">Ready to compare vendors</div>';
      }
    }
},
  
  filterComboBox(vendorType, searchTerm) {
      const optionsContainer = elements[`vendor${vendorType}Options`];
      const options = optionsContainer.getElementsByClassName('combo-box-option');
      
      for (const option of options) {
          const isVisible = option.dataset.value.toLowerCase().includes(searchTerm);
          option.classList.toggle('hidden', !isVisible);
      }
  },
  
  async runComparison() {
  // Clear any previous error states
  elements.vendorAInput.style.borderColor = '';
  elements.vendorBInput.style.borderColor = '';
  
  let hasErrors = false;
  let errorMessage = '';
  
  if (!this.vendorA) {
      elements.vendorAInput.style.borderColor = '#dc3545';
      elements.vendorAInput.placeholder = 'Please select Vendor A';
      hasErrors = true;
      errorMessage = 'Please select both vendors to compare';
  }
  
  if (!this.vendorB) {
      elements.vendorBInput.style.borderColor = '#dc3545';
      elements.vendorBInput.placeholder = 'Please select Vendor B';
      hasErrors = true;
      errorMessage = 'Please select both vendors to compare';
  }
  
  if (this.vendorA === this.vendorB) {
      elements.vendorAInput.style.borderColor = '#dc3545';
      elements.vendorBInput.style.borderColor = '#dc3545';
      hasErrors = true;
      errorMessage = 'Please select two different vendors';
  }
  
  if (hasErrors) {
      this.showError(
        elements.sankeyChart,
        'Selection Required',
        errorMessage
      );
      return;
  }
  
  this.isLoading = true;
  elements.runComparison.textContent = "Loading...";
  elements.runComparison.disabled = true;
  
  try {
    // Show loading state for main comparison area
    this.showLoading(elements.sankeyChart, 'Analyzing vendor competition...');
    
    // Small delay to show loading state
    await new Promise(resolve => setTimeout(resolve, 100));
    
    const vendorAData = app.filteredData.filter(c => c.vendor === this.vendorA);
    const vendorBData = app.filteredData.filter(c => c.vendor === this.vendorB);
    
    // Validate data
    const errors = this.validateVendorData(vendorAData, vendorBData);
    
    if (errors.length > 0) {
      this.showError(
        elements.sankeyChart,
        'Comparison Not Possible',
        errors.join('. '),
        true
      );
      return;
    }
    
    await this.createComparisonView(vendorAData, vendorBData);
    
  } catch (error) {
    console.error('Comparison error:', error);
    this.showError(
      elements.sankeyChart,
      'Comparison Failed',
      'An error occurred while creating the comparison. Please try again.',
      true
    );
  } finally {
    this.isLoading = false;
    elements.runComparison.textContent = "Update Comparison";
    elements.runComparison.disabled = false;
  }
},
  
  async createComparisonView(dataA, dataB) {
    try {
      // Update stats first (fastest)
      this.updateComparisonStats(dataA, dataB);
      
      // Show loading for overlap chart
      this.showLoading(elements.sankeyChart, 'Building competitive analysis...');
      await new Promise(resolve => setTimeout(resolve, 50));
      
      // Create overlap chart
      this.createOverlapChart(dataA, dataB);
      
      // Update other charts
      await this.updateComparisonTimeline(dataA, dataB);
      await this.updateComparisonIndustry(dataA, dataB);
      
    } catch (error) {
      console.error('Error creating comparison view:', error);
      throw error;
    }
  },
  
  updateComparisonStats(dataA, dataB) {
    const valueA = dataA.reduce((sum, c) => sum + utils.safeParseFloat(c.value), 0);
    const valueB = dataB.reduce((sum, c) => sum + utils.safeParseFloat(c.value), 0);
    const contractsA = dataA.length;
    const contractsB = dataB.length;
    const avgA = contractsA > 0 ? valueA / contractsA : 0;
    const avgB = contractsB > 0 ? valueB / contractsB : 0;
    const largestA = Math.max(0, ...dataA.map(c => c.value));
    const largestB = Math.max(0, ...dataB.map(c => c.value));
    
    elements.statCard3.style.display = 'none';
    elements.statCard4.style.display = 'none';
    
    elements.statCard1.innerHTML = `
        <div class="stat-label">${utils.truncateText(this.vendorA, 20)}</div>
        <div class="comparison-stat-grid">
            <div><div class="stat-label">Total Value</div><div class="stat-value">${utils.formatMoney(valueA)}</div></div>
            <div><div class="stat-label">Contracts</div><div class="stat-value">${contractsA}</div></div>
            <div><div class="stat-label">Avg Value</div><div class="stat-value">${utils.formatMoney(avgA)}</div></div>
            <div><div class="stat-label">Largest</div><div class="stat-value">${utils.formatMoney(largestA)}</div></div>
        </div>
    `;
    
    elements.statCard2.innerHTML = `
        <div class="stat-label">${utils.truncateText(this.vendorB, 20)}</div>
        <div class="comparison-stat-grid">
            <div><div class="stat-label">Total Value</div><div class="stat-value">${utils.formatMoney(valueB)}</div></div>
            <div><div class="stat-label">Contracts</div><div class="stat-value">${contractsB}</div></div>
            <div><div class="stat-label">Avg Value</div><div class="stat-value">${utils.formatMoney(avgB)}</div></div>
            <div><div class="stat-label">Largest</div><div class="stat-value">${utils.formatMoney(largestB)}</div></div>
        </div>
    `;
  },
  
  createOverlapChart(dataA, dataB) {
    elements.primaryChartTitle.textContent = "Competitive Overlap";
    elements.sankeyControls.classList.add('hidden');
    
    const container = elements.sankeyChart;
    
    try {
      const agencyData = {};
      dataA.forEach(c => {
          if (!agencyData[c.agency]) agencyData[c.agency] = { name: c.agency, valueA: 0, valueB: 0 };
          agencyData[c.agency].valueA += c.value;
      });
      
      dataB.forEach(c => {
          if (!agencyData[c.agency]) agencyData[c.agency] = { name: c.agency, valueA: 0, valueB: 0 };
          agencyData[c.agency].valueB += c.value;
      });
      
      const chartData = Object.values(agencyData)
        .filter(d => d.valueA > 0 || d.valueB > 0)
        .sort((a,b) => (b.valueA + b.valueB) - (a.valueA + a.valueB))
        .slice(0, 10)
        .map(d => ({...d, name: utils.truncateText(d.name, 25)}));
      
      if (chartData.length === 0) {
        this.showError(
          container,
          'No Agency Overlap',
          'These vendors don\'t compete at any agencies in the current filter.'
        );
        return;
      }
      
      const margin = {top: 40, right: 30, bottom: 40, left: 180};
      const width = container.clientWidth - margin.left - margin.right;
      const height = container.clientHeight - margin.top - margin.bottom;
      
      if (width <= 0 || height <= 0) {
        this.showError(container, 'Display Error', 'Chart area too small to display comparison.');
        return;
      }
      
      container.innerHTML = '';
      
      const svg = d3.select(container).append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .attr("class", "overlap-chart-container")
        .append("g")
          .attr("transform", `translate(${margin.left},${margin.top})`);
      
      const maxVal = d3.max(chartData, d => Math.max(d.valueA, d.valueB));
      
      const x = d3.scaleLinear().range([width/2, 0]).domain([0, maxVal]);
      const x2 = d3.scaleLinear().range([width/2, width]).domain([0, maxVal]);
      const y = d3.scaleBand()
        .range([0, height])
        .domain(chartData.map(d => d.name))
        .padding(0.2);
      
      svg.append("g").attr("class", "y-axis").call(d3.axisLeft(y));
      svg.append("g").attr("transform", `translate(0, ${height})`).call(d3.axisBottom(x).ticks(4).tickFormat(d => utils.formatMoney(d)));
      svg.append("g").attr("transform", `translate(0, ${height})`).call(d3.axisBottom(x2).ticks(4).tickFormat(d => utils.formatMoney(d)));
      
      const colorA = getComputedStyle(document.documentElement).getPropertyValue('--primary');
      const colorB = chartConfig.comparisonColorB;
      
      svg.selectAll(".barA").data(chartData).enter().append("rect")
        .attr("class", "barA").attr("x", d => x(d.valueA)).attr("y", d => y(d.name))
        .attr("width", d => width/2 - x(d.valueA)).attr("height", y.bandwidth()).attr("fill", colorA);
      
      svg.selectAll(".barB").data(chartData).enter().append("rect")
        .attr("class", "barB").attr("x", width/2).attr("y", d => y(d.name))
        .attr("width", d => x2(d.valueB) - width/2).attr("height", y.bandwidth()).attr("fill", colorB);
      
      svg.append("text").attr("x", width/4).attr("y", -10).attr("text-anchor", "middle").style("fill", colorA).text(utils.truncateText(this.vendorA, 20));
      svg.append("text").attr("x", width*0.75).attr("y", -10).attr("text-anchor", "middle").style("fill", colorB).text(utils.truncateText(this.vendorB, 20));
      
    } catch (error) {
      console.error('Error creating overlap chart:', error);
      this.showError(
        container,
        'Chart Error',
        'Failed to create competitive overlap visualization.',
        true
      );
    }
  },
  
  async updateComparisonTimeline(dataA, dataB) {
    const chart = app.charts.timeline;
    if (!chart) return;
    
    try {
      const monthlyDataA = {}, monthlyDataB = {};
      
      dataA.forEach(c => {
          if (c.parsedDate) {
              const key = `${c.parsedDate.getUTCFullYear()}-${(c.parsedDate.getUTCMonth() + 1).toString().padStart(2, '0')}`;
              monthlyDataA[key] = (monthlyDataA[key] || 0) + c.value;
          }
      });
      
      dataB.forEach(c => {
          if (c.parsedDate) {
              const key = `${c.parsedDate.getUTCFullYear()}-${(c.parsedDate.getUTCMonth() + 1).toString().padStart(2, '0')}`;
              monthlyDataB[key] = (monthlyDataB[key] || 0) + c.value;
          }
      });
      
      const allMonths = Array.from(new Set([...Object.keys(monthlyDataA), ...Object.keys(monthlyDataB)])).sort();
      
      chart.data.labels = allMonths.map(month => {
        const [year, monthNum] = month.split('-');
        return new Date(Date.UTC(parseInt(year), parseInt(monthNum) - 1)).toLocaleDateString('en-US', { month: 'short', year: '2-digit', timeZone: 'UTC' });
      });
      
      chart.data.datasets = [
        { label: utils.truncateText(this.vendorA, 15), data: allMonths.map(m => monthlyDataA[m] || 0), borderColor: getComputedStyle(document.documentElement).getPropertyValue('--primary'), tension: 0.4, fill: false },
        { label: utils.truncateText(this.vendorB, 15), data: allMonths.map(m => monthlyDataB[m] || 0), borderColor: chartConfig.comparisonColorB, tension: 0.4, fill: false }
      ];
      
      chart.options.plugins.legend.display = true;
      chart.update('none');
      
    } catch (error) {
      console.error('Timeline comparison error:', error);
      // Timeline errors are less critical, so just log them
    }
  },
  
  async updateComparisonIndustry(dataA, dataB) {
    try {
      if (app.charts.industry) app.charts.industry.destroy();
      
      const naicsData = {};
      dataA.forEach(c => {
          if(c.naics) {
              if (!naicsData[c.naics]) naicsData[c.naics] = { name: `${c.naics} - ${utils.truncateText(c.naicsDescription, 20)}`, valueA: 0, valueB: 0 };
              naicsData[c.naics].valueA += c.value;
          }
      });
      
      dataB.forEach(c => {
          if(c.naics) {
              if (!naicsData[c.naics]) naicsData[c.naics] = { name: `${c.naics} - ${utils.truncateText(c.naicsDescription, 20)}`, valueA: 0, valueB: 0 };
              naicsData[c.naics].valueB += c.value;
          }
      });
      
      const chartData = Object.values(naicsData)
          .sort((a,b) => (b.valueA + b.valueB) - (a.valueA + a.valueB))
          .slice(0, 7);
      
      app.charts.industry = new Chart(elements.industryChart, {
          type: 'bar',
          data: {
              labels: chartData.map(d => d.name),
              datasets: [
                  { label: utils.truncateText(this.vendorA, 15), data: chartData.map(d => d.valueA), backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--primary') },
                  { label: utils.truncateText(this.vendorB, 15), data: chartData.map(d => d.valueB), backgroundColor: chartConfig.comparisonColorB }
              ]
          },
          options: {
              responsive: true, maintainAspectRatio: false, indexAxis: 'y',
              scales: { x: { ticks: { callback: v => utils.formatMoney(v) } } },
              plugins: { legend: { position: 'bottom' } }
          }
      });
      
    } catch (error) {
      console.error('Industry comparison error:', error);
      // Industry chart errors are less critical
    }
  },
  
  clearComparison() {
    this.isActive = false;
    this.vendorA = null;
    this.vendorB = null;
    
    elements.statCard3.style.display = 'block';
    elements.statCard4.style.display = 'block';
    elements.vendorSelectors.classList.add('hidden');
    elements.closeComparison.classList.add('hidden');
    elements.sankeyControls.classList.remove('hidden');
    elements.primaryChartTitle.textContent = "Award Flow & NAICS Distribution";
    elements.runComparison.textContent = "Compare";
    
    elements.toggleComparison.classList.remove('btn-primary');
    elements.toggleComparison.classList.add('btn-secondary');
    
    elements.vendorAInput.value = '';
    elements.vendorBInput.value = '';
    
    this.populateComboBox('A');
    this.populateComboBox('B');
    
    charts.initAll();
    dashboard.updateAll();
  }
};
const eventListeners = {
  setup() {
    this.setupFileHandlers();
    this.setupFilterHandlers();
    this.setupUIHandlers();
    this.setupChartHandlers();
    this.setupModalHandlers();
    this.setupKeyboardHandlers();
    this.setupResizeHandler();
    this.setupTableScrollIndicators();
    this.setupThemeHandlers();
    this.setupGlobalListeners();
  },
  
  setupFileHandlers() {
      const dataLoadControls = document.querySelector('.data-load-controls');
if (dataLoadControls) {
    dataLoadControls.addEventListener('click', (e) => {
        if (e.target.matches('[data-dataset]')) {
            const dataset = e.target.dataset.dataset;
            dataProcessor.loadExampleData(dataset);
            updateDataSourceBanner(`${dataset}.csv`);
        }
    });
}
      
      if (elements.csvFile) {
    elements.csvFile.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            updateDataSourceBanner(file.name);
            const reader = new FileReader();
            reader.onload = (event) => dataProcessor.processData(event.target.result);
            reader.onerror = () => stateManager.showState('errorState', 'Error reading the file.');
            reader.readAsText(file);
        }
    });
}
  },
  
  setupFilterHandlers() {
    let searchTimeout;
    if (elements.searchInput) {
      elements.searchInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          stateManager.updateFilters({ search: e.target.value || null });
        }, 300);
      });
    }
    
    ['agency', 'vendor', 'naics', 'office'].forEach(type => {
      const element = elements[`${type}Filter`];
      if (element) {
        element.addEventListener('change', (e) => stateManager.updateFilters({ [type]: e.target.value || null }));
      }
    });
    
    ['startDate', 'endDate'].forEach(type => {
      const element = elements[type];
      if (element) {
        element.addEventListener('change', (e) => stateManager.updateFilters({ [type]: e.target.value || null }));
      }
    });
    
    if (elements.valueFilter) {
      elements.valueFilter.addEventListener('change', (e) => {
        const range = e.target.value ? utils.parseValueRange(e.target.value) : null;
        stateManager.updateFilters({ valueRange: range });
      });
    }
    
    if (elements.resetBtn) {
      elements.resetBtn.addEventListener('click', () => stateManager.resetFilters());
    }
    
    if (elements.moreFiltersBtn) {
      elements.moreFiltersBtn.addEventListener('click', () => elements.advancedFilters.classList.toggle('active'));
    }
    
    if (elements.toggleComparison) {
      elements.toggleComparison.addEventListener('click', () => comparisonManager.toggleMode());
    }
    
    if (elements.closeComparison) {
        elements.closeComparison.addEventListener('click', () => comparisonManager.clearComparison());
    }
    
    if (elements.runComparison) {
        elements.runComparison.addEventListener('click', () => comparisonManager.runComparison());
    }
    
    ['A', 'B'].forEach(v => {
        const comboBox = document.getElementById(`vendor${v}ComboBox`);
        const input = elements[`vendor${v}Input`];
        if (input) {
            input.addEventListener('input', () => comparisonManager.filterComboBox(v, input.value.toLowerCase()));
            input.addEventListener('click', () => comboBox.classList.toggle('open'));
            input.addEventListener('blur', () => setTimeout(() => comboBox.classList.remove('open'), 150));
        }
    });
  },
  
  setupUIHandlers() {
    const tabsContainer = document.querySelector('.tabs');
    if (tabsContainer) {
      tabsContainer.addEventListener('click', (e) => {
        if (e.target.matches('.tab-btn')) {
          document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
          
          e.target.classList.add('active');
          const tabId = e.target.dataset.tab + 'Tab';
          const tabContent = document.getElementById(tabId);
          if (tabContent) tabContent.classList.add('active');
        }
      });
    }
    
    const tableSection = document.querySelector('.table-section');
    if (tableSection) {
      tableSection.addEventListener('click', (e) => {
        if (e.target.matches('.view-details-btn')) {
          const contractId = e.target.dataset.contractId;
          if (contractId) modal.show(contractId);
        }
      });
    }
  },
  
  setupChartHandlers() {
    const chartControls = document.querySelector('.chart-controls');
    if (chartControls) {
      chartControls.addEventListener('click', (e) => {
        if (e.target.matches('.btn')) {
          const limitMap = { sankeyLimit10: 10, sankeyLimit25: 25, sankeyLimitAll: 0 };
          if (limitMap.hasOwnProperty(e.target.id)) {
            app.sankeyDisplayLimit = limitMap[e.target.id];
            sankeyChart.updateButtons(e.target.id);
            if (!comparisonManager.isActive) sankeyChart.update();
          }
        }
      });
    }
  },
  
  setupModalHandlers() {
    if (elements.closeModal) elements.closeModal.addEventListener('click', modal.close);
    if (elements.closeModalBtn) elements.closeModalBtn.addEventListener('click', modal.close);
    
    if (elements.contractModal) {
      elements.contractModal.addEventListener('click', (e) => {
        if (e.target === elements.contractModal) modal.close();
      });
    }
  },
  
  setupKeyboardHandlers() {
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        modal.close();
        if (elements.advancedFilters) elements.advancedFilters.classList.remove('active');
      }
    });
  },
  
  setupResizeHandler() {
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        if (comparisonManager.isActive) {
            comparisonManager.runComparison();
        } else {
            Object.values(app.charts).forEach(chart => chart && chart.resize && chart.resize());
            sankeyChart.update();
        }
      }, 250);
    });
  },
  
  setupTableScrollIndicators() { 
    const tableSections = document.querySelectorAll('.table-section');
    tableSections.forEach(section => {
      const handler = () => {
        const isScrollable = section.scrollWidth > section.clientWidth;
        section.classList.toggle('scrollable', isScrollable);
      };
      section.addEventListener('scroll', handler);
      window.addEventListener('resize', handler);
      handler(); 
    });
  },
  
  setupThemeHandlers() {
    const themeControls = document.getElementById('themeControls');
    if (themeControls) {
      themeControls.addEventListener('click', (e) => {
        if (e.target.matches('.theme-btn')) {
          themeManager.applyTheme(e.target.dataset.theme);
        }
      });
    }
  },
  
  setupGlobalListeners() {
      document.addEventListener('click', (e) => {
          if (!e.target.closest('#vendorAComboBox')) {
              document.getElementById('vendorAComboBox').classList.remove('open');
          }
          if (!e.target.closest('#vendorBComboBox')) {
              document.getElementById('vendorBComboBox').classList.remove('open');
          }
      });
  }
};
const fpdsSearchTemplates = {
  'it-services': {
    searchType: 'psc',
    naicsCode: '',
    pscCode: 'DA01',
    agencyName: '',
    startDate: '2023-01-01',
    endDate: '2025-12-31',
    minAmount: '100000',
    companyKeyword: ''
  },
  'cloud-saas': {
    searchType: 'psc',
    naicsCode: '',
    pscCode: 'DA10',
    agencyName: 'FEDERAL ACQUISITION SERVICE',
    startDate: '2024-01-01',
    endDate: '2025-12-31',
    minAmount: '500000',
    companyKeyword: ''
  },
  'large-awards': {
    searchType: 'naics',
    naicsCode: '',
    pscCode: '',
    agencyName: 'DEPT OF THE NAVY',
    startDate: '2024-01-01',
    endDate: '2025-12-31',
    minAmount: '5000000',
    companyKeyword: ''
  },
  'competitor-intel': {
    searchType: 'psc',
    naicsCode: '',
    pscCode: 'DA10',
    agencyName: '',
    startDate: '2023-01-01',
    endDate: '2025-12-31',
    minAmount: '1',
    companyKeyword: 'Microsoft'
  }
};
function toggleCodeOptions() {
  const searchType = document.getElementById('fpdsSearchType').value;
  const naicsGroup = document.getElementById('naicsGroup');
  const pscGroup = document.getElementById('pscGroup');
  
  if (searchType === 'psc') {
    naicsGroup.classList.add('hidden');
    pscGroup.classList.remove('hidden');
  } else {
    naicsGroup.classList.remove('hidden');
    pscGroup.classList.add('hidden');
  }
}
function loadSearchTemplate(templateName) {
  const template = fpdsSearchTemplates[templateName];
  if (!template) return;
  
  document.getElementById('fpdsSearchType').value = template.searchType;
  document.getElementById('fpdsNaicsCode').value = template.naicsCode;
  document.getElementById('fpdsPscCode').value = template.pscCode;
  document.getElementById('fpdsAgencyName').value = template.agencyName;
  document.getElementById('fpdsStartDate').value = template.startDate;
  document.getElementById('fpdsEndDate').value = template.endDate;
  document.getElementById('fpdsMinAmount').value = template.minAmount;
  document.getElementById('fpdsCompanyKeyword').value = template.companyKeyword;
  
  toggleCodeOptions(); // Show the right code dropdown
  generateFPDSSearch();
}

function generateFPDSSearch() {
  const formData = {
    searchType: document.getElementById('fpdsSearchType').value,
    naicsCode: document.getElementById('fpdsNaicsCode').value,
    pscCode: document.getElementById('fpdsPscCode').value,
    agencyName: document.getElementById('fpdsAgencyName').value,
    startDate: document.getElementById('fpdsStartDate').value,
    endDate: document.getElementById('fpdsEndDate').value,
    minAmount: document.getElementById('fpdsMinAmount').value,
    companyKeyword: document.getElementById('fpdsCompanyKeyword').value
  };
  
  let searchParts = [];
  
  // NAICS or PSC Code
  if (formData.searchType === 'psc' && formData.pscCode) {
    searchParts.push(`PRODUCT_OR_SERVICE_CODE:"${formData.pscCode}"`);
  } else if (formData.searchType === 'naics' && formData.naicsCode) {
    searchParts.push(`PRINCIPAL_NAICS_CODE:"${formData.naicsCode}"`);
  }
  
  // Rest of the function stays the same...
  if (formData.agencyName) {
    searchParts.push(`CONTRACTING_AGENCY_NAME:"${formData.agencyName}"`);
  }
  
  if (formData.startDate) {
    const startFormatted = formData.startDate.replace(/-/g, '/');
    const endFormatted = formData.endDate ? formData.endDate.replace(/-/g, '/') : '';
    searchParts.push(`SIGNED_DATE:[${startFormatted},${endFormatted}]`);
  }
  
  if (formData.minAmount) {
    searchParts.push(`OBLIGATED_AMOUNT:[${formData.minAmount},)`);
  }
  
  if (formData.companyKeyword) {
    searchParts.push(`DESCRIPTION_OF_REQUIREMENT:"${formData.companyKeyword}"`);
  }
  
  const searchString = searchParts.join(' ');
  
  document.getElementById('fpdsSearchString').value = searchString;
  document.getElementById('fpdsSearchOutput').style.display = 'block';
  
  generateFPDSPreview(formData);
  generateFPDSDirectURL(searchString);
}

function generateFPDSPreview(formData) {
  let previewText = "This search will find: ";
  let conditions = [];
  
  if (formData.naicsCode) {
    const naicsSelect = document.getElementById('fpdsNaicsCode');
    const naicsText = naicsSelect.options[naicsSelect.selectedIndex].text;
    conditions.push(naicsText);
  }
  
  if (formData.agencyName) {
    conditions.push(`contracts from ${formData.agencyName}`);
  }
  
  if (formData.minAmount) {
    conditions.push(`worth $${parseInt(formData.minAmount).toLocaleString()}+`);
  }
  
  if (formData.startDate && formData.endDate) {
    conditions.push(`signed between ${formData.startDate} and ${formData.endDate}`);
  }
  
  if (formData.companyKeyword) {
    conditions.push(`mentioning "${formData.companyKeyword}"`);
  }
  
  if (conditions.length > 0) {
    previewText += conditions.join(', ') + ".";
    document.getElementById('fpdsSearchPreview').textContent = previewText;
    document.getElementById('fpdsSearchPreview').style.display = 'block';
  }
}

function generateFPDSDirectURL(searchString) {
  // URL encode the search string for FPDS
  const encodedSearch = encodeURIComponent(searchString);
  const fpdsURL = `https://www.fpds.gov/ezsearch/fpdsportal?indexName=awardfull&templateName=1.5.3&s=FPDS.GOV&q=${encodedSearch}`;
  
  document.getElementById('directFPDSLink').href = fpdsURL;
}

function copyFPDSSearch() {
  const searchString = document.getElementById('fpdsSearchString');
  searchString.select();
  searchString.setSelectionRange(0, 99999); // For mobile devices
  document.execCommand('copy');
  
  // Show feedback
  const button = event.target.closest('button');
  const originalHTML = button.innerHTML;
  button.innerHTML = '<i class="fas fa-check"></i> Copied!';
  button.style.background = 'var(--primary)';
  
  setTimeout(() => {
    button.innerHTML = originalHTML;
    button.style.background = '';
  }, 2000);
}

function showFPDSInstructions() {
  document.getElementById('fpdsInstructionsModal').style.display = 'flex';
}

function closeFPDSInstructions() {
  document.getElementById('fpdsInstructionsModal').style.display = 'none';
}

// Close modal when clicking outside
document.addEventListener('click', (e) => {
  const modal = document.getElementById('fpdsInstructionsModal');
  if (e.target === modal) {
    closeFPDSInstructions();
  }
});

// Initialize with IT Services template when page loads
document.addEventListener('DOMContentLoaded', () => {
  if (document.getElementById('fpdsNaicsCode')) {
    loadSearchTemplate('it-services');
  }
});
function init() {
  cacheElements();
  themeManager.init();
  eventListeners.setup();
  
  // Load example data automatically instead of showing empty state
  loadExampleDataOnInit();
}

async function loadExampleDataOnInit() {
  try {
    stateManager.showState('loadingState');
    
    const response = await fetch(`${app.s3BaseUrl}navy_cloud.csv`);
    
    if (!response.ok) {
      console.warn('navy_cloud.csv not found, loading default dataset');
      dataProcessor.loadExampleData('dhs_CY24_25');
      updateDataSourceBanner('dhs_CY24_25.csv');
      return;
    }
    
    const csvText = await response.text();
    dataProcessor.processData(csvText);
    updateDataSourceBanner('navy_cloud.csv');
    
  } catch (error) {
    console.error('Error loading example data:', error);
    dataProcessor.loadExampleData('dhs_CY24_25');
    updateDataSourceBanner('dhs_CY24_25.csv');
  }
}

function updateDataSourceBanner(filename) {
  app.currentDataSource = filename;
  const banner = document.getElementById('dataSourceBanner');
  const filenameElement = document.getElementById('dataSourceFilename');
  
  if (banner && filenameElement) {
    filenameElement.textContent = filename;
    banner.classList.remove('hidden');
  }
}

function hideDataSourceBanner() {
  const banner = document.getElementById('dataSourceBanner');
  if (banner) {
    banner.classList.add('hidden');
  }
}

document.addEventListener('DOMContentLoaded', () => {
  const checkLibraries = () => {
    if (typeof Chart !== 'undefined' && typeof d3 !== 'undefined' && d3.sankey) {
      init();
    } else {
      setTimeout(checkLibraries, 100);
    }
  };
  checkLibraries();
});
</script>
</body>
</html>